<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Loremipsum Blog</title>
  <icon>https://www.gravatar.com/avatar/bcce300a816652e13f1514ef10ae2d8a</icon>
  <subtitle>Things always get worse before they get better.</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://loremipsumsharp.github.io/"/>
  <updated>2021-06-13T09:24:06.103Z</updated>
  <id>https://loremipsumsharp.github.io/</id>
  
  <author>
    <name>Loremipsum</name>
    <email>mvclogic@gmail.com</email>
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>使用Autofixture提高单元测试编写效率</title>
    <link href="https://loremipsumsharp.github.io/2021/06/13/%E4%BD%BF%E7%94%A8Autofixture%E6%8F%90%E9%AB%98%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E7%BC%96%E5%86%99%E6%95%88%E7%8E%87/"/>
    <id>https://loremipsumsharp.github.io/2021/06/13/%E4%BD%BF%E7%94%A8Autofixture%E6%8F%90%E9%AB%98%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E7%BC%96%E5%86%99%E6%95%88%E7%8E%87/</id>
    <published>2021-06-13T08:41:09.000Z</published>
    <updated>2021-06-13T09:24:06.103Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在编写单元测试的过程中，我们常常需要将一些测试的非关注点以Moq的形式去掉，如一些外部的grpc调用、数据库依赖，redis依赖等。eg:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[Fact]</span><br><span class="line">public async Task TestAddSubscription_WhenExists_ThrownException()</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; arrange</span><br><span class="line">    var subscription &#x3D; new Subscription()</span><br><span class="line">    &#123;</span><br><span class="line">        SourceCode &#x3D; &quot;sys_db-pt_role&quot;,</span><br><span class="line">        SourceVersion &#x3D; 2,</span><br><span class="line">        SourceTimestamp &#x3D; 1622014384,</span><br><span class="line">        TargetCode &#x3D; &quot;EU-Target&#x2F;EU-SYS-Db&#x2F;sys_db-pt_role&quot;,</span><br><span class="line">        TargetVersion &#x3D; 0,</span><br><span class="line">        TargetTimestamp &#x3D; 0,</span><br><span class="line">        Status &#x3D; SubscriptionStatus.UnSynchronized,</span><br><span class="line">        LastPullTime &#x3D; DateTime.Now,</span><br><span class="line">        CreateTime &#x3D; DateTime.Now,</span><br><span class="line">        IsEnable &#x3D; true</span><br><span class="line">    &#125;;</span><br><span class="line">    var mockSubscriptionRepo &#x3D; new Mock&lt;ISubscriptionRepository&gt;();</span><br><span class="line">    mockSubscriptionRepo.Setup(x &#x3D;&gt; x.GetSubscription(subscription.SourceCode, subscription.TargetCode))</span><br><span class="line">    .ReturnsAsync(new Subscription());</span><br><span class="line">    var mockTargetServerRepository &#x3D; new Mock&lt;ITargetServerRepository&gt;();</span><br><span class="line">    var mockTargetServerClient &#x3D; new Mock&lt;ITargetServerClient&gt;();</span><br><span class="line">    var mockPushTaskRepository &#x3D; new Mock&lt;IPushTaskRepository&gt;();</span><br><span class="line">    var mockSourceServerClient &#x3D; new Mock&lt;ISourceServerClient&gt;();</span><br><span class="line">    SubscriptionService subscriptionService &#x3D; new SubscriptionService(mockTargetServerRepository.Object,mockSubscriptionRepo.Object,targetServerClient.Object,mockPushTaskRepository.Object,mockSourceServerClient.Object)</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; act</span><br><span class="line">    Task act() &#x3D;&gt; subscriptionService.AddSubscription(subscription, new TargetServer(), string.Empty, string.Empty, string.Empty);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; assert</span><br><span class="line">    await Assert.ThrowsAsync&lt;SiteErrorException&gt;(act);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SubscriptionService的定义如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class SubscriptionService : ISubscriptionService</span><br><span class="line">&#123;</span><br><span class="line">   private readonly ITargetServerRepository _targetServerRepository;</span><br><span class="line">   private readonly ISubscriptionRepository _subscriptionRepository;</span><br><span class="line">   private readonly IPushTaskRepository _pushTaskRepository;</span><br><span class="line">   private readonly ITargetServerClient _targetServerClient;</span><br><span class="line">   private readonly ISourceServerClient _sourceServerClient;</span><br><span class="line">   private readonly ILogger&lt;SubscriptionService&gt; _logger;</span><br><span class="line"></span><br><span class="line">   private static string _lockKeyPattern &#x3D; &quot;&#123;0&#125;:&#123;1&#125;:SubscriptionSync&quot;;</span><br><span class="line">   private static readonly ConcurrentDictionary&lt;string, SemaphoreSlim&gt; _locks &#x3D; new ConcurrentDictionary&lt;string, SemaphoreSlim&gt;();</span><br><span class="line"></span><br><span class="line">   public SubscriptionService(ITargetServerRepository targetServerRepository, ISubscriptionRepository subscriptionRepository, ITargetServerClient targetServerClient, IPushTaskRepository pushTaskRepository, ISourceServerClient sourceServerClient, ILogger&lt;SubscriptionService&gt; logger)</span><br><span class="line">   &#123;</span><br><span class="line">       _targetServerRepository &#x3D; targetServerRepository;</span><br><span class="line">       _subscriptionRepository &#x3D; subscriptionRepository;</span><br><span class="line">       _targetServerClient &#x3D; targetServerClient;</span><br><span class="line">       _pushTaskRepository &#x3D; pushTaskRepository;</span><br><span class="line">       _sourceServerClient &#x3D; sourceServerClient;</span><br><span class="line">       _logger &#x3D; logger;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上述写法存在的弊端：</p><ol><li>需要Mock大量对象，导致单元测试的arrange阶段极为冗长</li><li>如果SubscriptionServices的构造函数发生变化，那么这个单元测试无法通过</li></ol><p>实际上，在上面的这个单元测试，我们仅仅关注ISubscriptionRepository，那么有没有办法通过一些手段来解决问题1、2呢？</p><h2 id="使用Autofixture编写单元测试"><a href="#使用Autofixture编写单元测试" class="headerlink" title="使用Autofixture编写单元测试"></a>使用Autofixture编写单元测试</h2><p>AutoFixture 是一个 .NET 的开源框架，主要设计目的是最小化单元测试的arrange阶段。可以让开发者把重点放在测试的目标而不是设置测试场景。</p><p>通过Autofixture,可以实现Moq的自动化，我们只需要将我们的精力聚焦在我们要测试的点上，也就是说我们只需要关注我们测试需要用到的一些Mock对象。</p><p>通过Autofixture重构后的代码如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public class TestSubscriptionService</span><br><span class="line">&#123;</span><br><span class="line">    private readonly Fixture _fixture;</span><br><span class="line">    public TestSubscriptionService()</span><br><span class="line">    &#123;</span><br><span class="line">        _fixture &#x3D; new Fixture();</span><br><span class="line">        _fixture.Customize(new AutoMoqCustomization());</span><br><span class="line">    &#125;</span><br><span class="line">    [Fact]</span><br><span class="line">    public async Task TestAddSubscription_WhenExists_ThrownException()</span><br><span class="line">    &#123;</span><br><span class="line">        var subscription &#x3D; new Subscription()</span><br><span class="line">        &#123;</span><br><span class="line">            SourceCode &#x3D; &quot;sys_db-pt_role&quot;,</span><br><span class="line">            SourceVersion &#x3D; 2,</span><br><span class="line">            SourceTimestamp &#x3D; 1622014384,</span><br><span class="line">            TargetCode &#x3D; &quot;EU-Target&#x2F;EU-SYS-Db&#x2F;sys_db-pt_role&quot;,</span><br><span class="line">            TargetVersion &#x3D; 0,</span><br><span class="line">            TargetTimestamp &#x3D; 0,</span><br><span class="line">            Status &#x3D; SubscriptionStatus.UnSynchronized,</span><br><span class="line">            LastPullTime &#x3D; DateTime.Now,</span><br><span class="line">            CreateTime &#x3D; DateTime.Now,</span><br><span class="line">            IsEnable &#x3D; true</span><br><span class="line">        &#125;;</span><br><span class="line">        var mockSubscriptionRepo &#x3D; new Mock&lt;ISubscriptionRepository&gt;();</span><br><span class="line">        mockSubscriptionRepo.Setup(x &#x3D;&gt; x.GetSubscription(subscription.SourceCode, subscription.TargetCode))</span><br><span class="line">            .ReturnsAsync(new Subscription());</span><br><span class="line">        _fixture.Register&lt;ISubscriptionRepository&gt;(() &#x3D;&gt; mockSubscriptionRepo.Object);</span><br><span class="line">        SubscriptionService subscriptionService &#x3D; _fixture.Create&lt;SubscriptionService&gt;();</span><br><span class="line"></span><br><span class="line">        Task act() &#x3D;&gt; subscriptionService.AddSubscription(subscription, new TargetServer(), string.Empty, string.Empty, string.Empty);</span><br><span class="line"></span><br><span class="line">        await Assert.ThrowsAsync&lt;SiteErrorException&gt;(act);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如上所示:</p><ol><li>当构造函数发生变更后，我们无需重写单元测试，Autofixture会自动帮我们Mock一些非测试关注的对象</li><li>极大的简化了arrange阶段的代码量</li></ol><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://stackoverflow.com/questions/34788365/how-to-add-a-specific-implementation-of-a-mock-created-with-autofixture" target="_blank" rel="noopener">How to add a specific implementation of a Mock created with Autofixture</a></p><p><a href="https://blog.ploeh.dk/2011/04/19/ConstructorstrategiesforAutoFixture/" target="_blank" rel="noopener">Constructor strategies for AutoFixture</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;在编写单元测试的过程中，我们常常需要将一些测试的非关注点以Moq的形式去掉，如一些外部的grpc调用、数据库依赖，redis依赖等。eg:&lt;
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>使用SourceLink调试Nuget包源码</title>
    <link href="https://loremipsumsharp.github.io/2021/05/16/%E4%BD%BF%E7%94%A8SourceLink%E8%B0%83%E8%AF%95Nuget%E5%8C%85/"/>
    <id>https://loremipsumsharp.github.io/2021/05/16/%E4%BD%BF%E7%94%A8SourceLink%E8%B0%83%E8%AF%95Nuget%E5%8C%85/</id>
    <published>2021-05-16T15:27:39.659Z</published>
    <updated>2021-05-16T16:25:02.920Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在日常开发中，我们将一些封装好的类库以nuget包的形式发布到nuget服务器上，通过引用这些nuget包来增加开发效率，减少重复代码。由于nuget包的本质上是一个dll，在使用nuget包的过程中，我们无法直接调试与之对应的源码，当一些以nuget包提供的第三方类库报错或发生异常时，我们往往需要去相应的仓库克隆相关的源码，并将nuget包引用替换为源码引用，通过直接源码调试来定位具体的问题。</p><p>那么是否存在一种开箱即用的工具，能够应付上述的场景?答案是:<a href="https://github.com/dotnet/sourcelink" target="_blank" rel="noopener">SourceLink</a></p><p>SourceLink是Microsoft的一个开源项目，开发者只需在项目文件(.csproj)进行简单的配置便可以让生成的nuget包嵌入相关的源码信息。当开发者进行调试的时候，.NET Debugger便会利用pdb文件中的源码信息，直接将断点定位具体源码，用户无需再去克隆相关源码进行调试。</p><p>目前SourceLink支持的最低.NET CORE SDK版本是2.1.300</p><h2 id="项目设置"><a href="#项目设置" class="headerlink" title="项目设置"></a>项目设置</h2><p>在项目文件增加如下的配置项：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;PropertyGroup&gt;</span><br><span class="line">    &lt;PublishRepositoryUrl&gt;true&lt;&#x2F;PublishRepositoryUrl&gt;</span><br><span class="line">    &lt;EmbedUntrackedSources&gt;true&lt;&#x2F;EmbedUntrackedSources&gt;</span><br><span class="line">    &lt;IncludeSymbols&gt;true&lt;&#x2F;IncludeSymbols&gt;</span><br><span class="line">    &lt;SymbolPackageFormat&gt;snupkg&lt;&#x2F;SymbolPackageFormat&gt;</span><br><span class="line">    &lt;!-- &lt;EmbedAllSources&gt;true&lt;&#x2F;EmbedAllSources&gt; --&gt;</span><br><span class="line">  &lt;&#x2F;PropertyGroup&gt;</span><br></pre></td></tr></table></figure><h3 id="IncludeSymbols-amp-amp-SymbolPackageFormat"><a href="#IncludeSymbols-amp-amp-SymbolPackageFormat" class="headerlink" title="IncludeSymbols &amp;&amp; SymbolPackageFormat"></a>IncludeSymbols &amp;&amp; SymbolPackageFormat</h3><p>这两个设置可以让发布nuget包带上pdb信息</p><h3 id="EmbedUntrackedSources-amp-amp-EmbedAllSources"><a href="#EmbedUntrackedSources-amp-amp-EmbedAllSources" class="headerlink" title="EmbedUntrackedSources &amp;&amp; EmbedAllSources"></a>EmbedUntrackedSources &amp;&amp; EmbedAllSources</h3><p>当EmbedAllSources设置为true的时候，会将所有源码信息内嵌到pdb文件中，后续调试的时候不需要再从git拉取。反之EmbedUntrackedSources则只会将那些没有被git管理到源码嵌入到pdb文件中</p><h3 id="PublishRepositoryUrl"><a href="#PublishRepositoryUrl" class="headerlink" title="PublishRepositoryUrl"></a>PublishRepositoryUrl</h3><p>让sourcelink可以找到相关的源码文件</p><h2 id="源码控制设置"><a href="#源码控制设置" class="headerlink" title="源码控制设置"></a>源码控制设置</h2><p>目前sourcelink支持一下集中源码管理：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Microsoft.SourceLink.GitHub (depends on Microsoft.Build.Tasks.Git package)</span><br><span class="line">Microsoft.SourceLink.AzureRepos.Git (depends on Microsoft.Build.Tasks.Git package)</span><br><span class="line">Microsoft.SourceLink.AzureDevOpsServer.Git (depends on Microsoft.Build.Tasks.Git package)</span><br><span class="line">Microsoft.SourceLink.GitLab (depends on Microsoft.Build.Tasks.Git package)</span><br><span class="line">Microsoft.SourceLink.Bitbucket.Git (depends on Microsoft.Build.Tasks.Git package)</span><br></pre></td></tr></table></figure><p>如过你的nuget包的源码是托管再github上，那么再项目文件中需要增加如下引用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;ItemGroup Label&#x3D;&quot;SourceLink&quot;&gt;</span><br><span class="line">    &lt;PackageReference Include&#x3D;&quot;Microsoft.SourceLink.GitHub&quot; Version&#x3D;&quot;1.0.0&quot; PrivateAssets&#x3D;&quot;All&quot; &gt;</span><br><span class="line">      &lt;PrivateAssets&gt;all&lt;&#x2F;PrivateAssets&gt;</span><br><span class="line">      &lt;IncludeAssets&gt;runtime; build; native; contentfiles; analyzers&lt;&#x2F;IncludeAssets&gt;</span><br><span class="line">    &lt;&#x2F;PackageReference&gt;</span><br><span class="line">  &lt;&#x2F;ItemGroup&gt;</span><br></pre></td></tr></table></figure><h3 id="构建并打包"><a href="#构建并打包" class="headerlink" title="构建并打包"></a>构建并打包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dotnet build -c Release</span><br><span class="line">dotnet pack -c Release</span><br></pre></td></tr></table></figure><p>安装sourcelink cli工具</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet tool install --global sourcelink</span><br></pre></td></tr></table></figure><p>验证相关的pdb文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sourcelink test SVNSourceLinkDemo.Common.pdb </span><br><span class="line">sourcelink test passed: SVNSourceLinkDemo.Common.pdb</span><br></pre></td></tr></table></figure><p>查看相关sourcelink信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sourcelink print-json  SVNSourceLinkDemo.Common.pdb</span><br><span class="line">&#123;&quot;documents&quot;:&#123;&quot;C:\\Development\\NetCore\\SVNSourceLinkDemo\\*&quot;:&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;LoremipsumSharp&#x2F;SVNSourceLinkDemo&#x2F;8a302ea20ba8b3d3fd81086f2f28a0c7183e185a&#x2F;*&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p>其中注意到<strong>8a302ea20ba8b3d3fd81086f2f28a0c7183e185a</strong>，这个guid是git的commit id</p><h2 id="调试配置"><a href="#调试配置" class="headerlink" title="调试配置"></a>调试配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F; Use IntelliSense to find out which attributes exist for C# debugging</span><br><span class="line">            &#x2F;&#x2F; Use hover for the description of the existing attributes</span><br><span class="line">            &#x2F;&#x2F; For further information visit https:&#x2F;&#x2F;github.com&#x2F;OmniSharp&#x2F;omnisharp-vscode&#x2F;blob&#x2F;master&#x2F;debugger-launchjson.md</span><br><span class="line">            &quot;name&quot;: &quot;.NET Core Launch (console)&quot;,</span><br><span class="line">            &quot;type&quot;: &quot;coreclr&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">            &quot;preLaunchTask&quot;: &quot;build&quot;,</span><br><span class="line">            &#x2F;&#x2F; If you have changed target frameworks, make sure to update the program path.</span><br><span class="line">            &quot;program&quot;: &quot;$&#123;workspaceFolder&#125;&#x2F;bin&#x2F;Debug&#x2F;netcoreapp2.1&#x2F;HelloWorld.dll&quot;,</span><br><span class="line">            &quot;args&quot;: [],</span><br><span class="line">            &quot;cwd&quot;: &quot;$&#123;workspaceFolder&#125;&quot;,</span><br><span class="line">            &#x2F;&#x2F; For more information about the &#39;console&#39; field, see https:&#x2F;&#x2F;aka.ms&#x2F;VSCode-CS-LaunchJson-Console</span><br><span class="line">            &quot;console&quot;: &quot;internalConsole&quot;,</span><br><span class="line">            &quot;stopAtEntry&quot;: false,</span><br><span class="line">            &quot;justMyCode&quot;: false,</span><br><span class="line">            &quot;symbolOptions&quot;: &#123;</span><br><span class="line">                &quot;searchPaths&quot;: [],</span><br><span class="line">                &quot;searchMicrosoftSymbolServer&quot;: true,</span><br><span class="line">                &quot;searchNuGetOrgSymbolServer&quot;: true,</span><br><span class="line">                &quot;moduleFilter&quot;: &#123;</span><br><span class="line">                    &quot;mode&quot;: &quot;loadOnlyIncluded&quot;,</span><br><span class="line">                    &quot;excludedModules&quot;: [&quot;SVNSourceLinkDemo*.dll&quot;]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot;: &quot;.NET Core Attach&quot;,</span><br><span class="line">            &quot;type&quot;: &quot;coreclr&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;attach&quot;,</span><br><span class="line">            &quot;processId&quot;: &quot;$&#123;command:pickProcess&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中justMyCode与symbolOptions是新增vscode调试配置</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://queil.net/blog/2019/seamless-debugging-of-nuget-packages/" target="_blank" rel="noopener">SEAMLESS DEBUGGING OF NUGET PACKAGES</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;在日常开发中，我们将一些封装好的类库以nuget包的形式发布到nuget服务器上，通过引用这些nuget包来增加开发效率，减少重复代码。由于
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>使用Utf8Json改善Ocelot对象序列化的性能</title>
    <link href="https://loremipsumsharp.github.io/2021/04/07/%E4%BD%BF%E7%94%A8Utf8Json%E6%94%B9%E5%96%84Ocelot%E5%AF%B9%E8%B1%A1%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E6%80%A7%E8%83%BD/"/>
    <id>https://loremipsumsharp.github.io/2021/04/07/%E4%BD%BF%E7%94%A8Utf8Json%E6%94%B9%E5%96%84Ocelot%E5%AF%B9%E8%B1%A1%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E6%80%A7%E8%83%BD/</id>
    <published>2021-04-06T17:00:00.000Z</published>
    <updated>2021-04-06T19:34:24.845Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>近期在对部门的crm系统进行服务化改造，服务化改造过程中，选择了ocelot作为api网关。各个服务的response到达ocelot之后，ocelot会对response做进一步封装，形成统一的规范格式后再返回给client，eg：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class Response</span><br><span class="line">&#123;</span><br><span class="line">    public Response(object data)</span><br><span class="line">    &#123;</span><br><span class="line">        Code &#x3D; 0;</span><br><span class="line">        Data &#x3D; data;</span><br><span class="line">        Message &#x3D; &quot;Success&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public Response(string message, int code &#x3D; 500)</span><br><span class="line">    &#123;</span><br><span class="line">        Code &#x3D; code;</span><br><span class="line">        Message &#x3D; message;</span><br><span class="line">    &#125;</span><br><span class="line">    public int Code &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    public string Message &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    public object Data &#123; get; set; &#125; &#x2F;&#x2F; 服务端返回的数据</span><br><span class="line"></span><br><span class="line">    public bool Success &#123; get &#123; return Code &#x3D;&#x3D; 0; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    public string Error &#123;get;set;&#125;</span><br></pre></td></tr></table></figure><p>通过ocelot对response格式进行统一处理，这样依赖就不需要每个服务再去单独写一个ResultFilter来处理，减少了大量重复代码。</p><p>为了实现这个功能，那么就必须在ocelot中对各个服务的response进行序列化/反序列化处理。这样势必对ocelot的性能造成一定的影响。<br>那么有没有办法优化序列化/反序列化的性能呢？</p><h2 id="Utf8Json"><a href="#Utf8Json" class="headerlink" title="Utf8Json"></a>Utf8Json</h2><p><a href="https://github.com/neuecc/Utf8Json" target="_blank" rel="noopener">Utf8Json</a> 是一个日本人写的一个Json序列化器，目前宣称是拥有最好的序列化性能。相关<a href="https://michaelscodingspot.com/the-battle-of-c-to-json-serializers-in-net-core-3/" target="_blank" rel="noopener">结论</a>也支持这一观点:</p><p><strong>For serialization, Utf8Json is 2 times faster than System.Text.Json and a whole 4 times faster than Newtonsoft. For deserialization, Utf8Json is 3.5 times faster than System.Text.Json and 6 times faster than Newtonsoft.</strong></p><p>查阅官方文档，utf8json之所以这么快主要原因有如下几个：</p><ol><li>不需要额外的内存分配<br>以Json.NET为例，如果我们希望将一个对象变成一个字节数组,待会会有以下两种方法：</li></ol><p>方法一：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public static byte[] SerializeJson(DrawDescriptionLayer layer)</span><br><span class="line">&#123;</span><br><span class="line">    var s &#x3D; JsonConvert.SerializeObject(layer, js);</span><br><span class="line">    return Encoding.UTF8.GetBytes(s); &#x2F;&#x2F;rent from array pool here</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>方法二：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public static byte[] SerializeJson2(DrawDescriptionLayer layer)</span><br><span class="line">&#123;</span><br><span class="line">    using (var ms &#x3D; new MemoryStream())</span><br><span class="line">    using (StreamWriter writer &#x3D; new StreamWriter(ms, Encoding.UTF8))</span><br><span class="line">    using (JsonTextWriter jsonWriter &#x3D; new JsonTextWriter(writer))</span><br><span class="line">    &#123;</span><br><span class="line">        JsonSerializer ser &#x3D; JsonSerializer.Create(js);</span><br><span class="line">        ser.Serialize(jsonWriter, layer);</span><br><span class="line">        jsonWriter.Flush();</span><br><span class="line">        return ms.ToArray(); &#x2F;&#x2F;rent from array pool here</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上两种方法都无一例外的产生了额外的内存分配，效率不高。以方法二为例，创建一个新的streamwriter就会导致一个bytes[3075]的allocation，很有可能我们并不需要这么多，同理UTF8.GetBytes也有这个问题。</p><p>而Utf8json则做到了按需分配，比如，当我们执行如下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var bytes &#x3D; Utf8Json.JsonSerializer.Serialize(obj1, jsonresolver);</span><br></pre></td></tr></table></figure><p>utf8json首先会从内存池取出一个buffer（每个线程一个副本）来生成bytes数组的具体内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static byte[] Serialize&lt;T&gt;(T value, IJsonFormatterResolver resolver)</span><br><span class="line">        &#123;</span><br><span class="line">            if (resolver &#x3D;&#x3D; null) resolver &#x3D; DefaultResolver;</span><br><span class="line"></span><br><span class="line">            var writer &#x3D; new JsonWriter(MemoryPool.GetBuffer());</span><br><span class="line">            var formatter &#x3D; resolver.GetFormatterWithVerify&lt;T&gt;();</span><br><span class="line">            formatter.Serialize(ref writer, value, resolver);</span><br><span class="line">            return writer.ToUtf8ByteArray();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>然后将bytes数据拷贝的dst后返回给调用端</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">byte[] FastCloneWithResize(byte[] src, int newSize)</span><br><span class="line">        &#123;</span><br><span class="line">            if (newSize &lt; 0) throw new ArgumentOutOfRangeException(&quot;newSize&quot;);</span><br><span class="line">            if (src.Length &lt; newSize) throw new ArgumentException(&quot;length &lt; newSize&quot;);</span><br><span class="line"></span><br><span class="line">            if (src &#x3D;&#x3D; null) return new byte[newSize];</span><br><span class="line"></span><br><span class="line">            byte[] dst &#x3D; new byte[newSize];</span><br><span class="line"></span><br><span class="line">#if NETSTANDARD &amp;&amp; !NET45</span><br><span class="line">            fixed (byte* pSrc &#x3D; &amp;src[0])</span><br><span class="line">            fixed (byte* pDst &#x3D; &amp;dst[0])</span><br><span class="line">            &#123;</span><br><span class="line">                Buffer.MemoryCopy(pSrc, pDst, dst.Length, newSize);</span><br><span class="line">            &#125;</span><br><span class="line">#else</span><br><span class="line">            Buffer.BlockCopy(src, 0, dst, 0, newSize);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">            return dst;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>这样依赖内存可以复用，并且没有带来额外的损耗</p><p>2.对数值型到字符串的转化进行了特定的优化，如int-&gt;string（itoa）,double-&gt;string(google/double-conversion)</p><p>3.<a href="https://github.com/dotnet/coreclr/pull/3118" target="_blank" rel="noopener">优化了Buffer.MemoryCopy的性能问题</a></p><p>等等。</p><h2 id="重构"><a href="#重构" class="headerlink" title="重构"></a>重构</h2><p>定义一个Formatter专门用于处理服务端的response：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F;  Utf8Json的JRaw,压榨性能</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public class JRawFormatter : IJsonFormatter&lt;JRaw&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        public static JRawFormatter Instance;</span><br><span class="line"></span><br><span class="line">        static JRawFormatter()</span><br><span class="line">        &#123;</span><br><span class="line">            Instance &#x3D; new JRawFormatter();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F;  没有反序列化场景，暂时不管</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;reader&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;formatterResolver&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;returns&gt;&lt;&#x2F;returns&gt;</span><br><span class="line">        public JRaw Deserialize(ref JsonReader reader, IJsonFormatterResolver formatterResolver)</span><br><span class="line">        &#123;</span><br><span class="line">            throw new System.NotImplementedException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F;  </span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;writer&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;value&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;formatterResolver&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line">        public void Serialize(ref JsonWriter writer, JRaw value, IJsonFormatterResolver formatterResolver)</span><br><span class="line">        &#123;</span><br><span class="line">            if (value &#x3D;&#x3D; null)</span><br><span class="line">            &#123;</span><br><span class="line">                writer.WriteNull();</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            writer.WriteRaw(value.Payload);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>处理服务端返回：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public override async Task SetResponseOnHttpContextBody(HttpContext httpContext, DownstreamResponse response)</span><br><span class="line">        &#123;</span><br><span class="line">            object body &#x3D; default;</span><br><span class="line"></span><br><span class="line">            if (response.IsEmptyResponse())</span><br><span class="line">            &#123;</span><br><span class="line">                body &#x3D; new Response(null, 0);</span><br><span class="line">                httpContext.Response.StatusCode &#x3D; (int)HttpStatusCode.OK;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                var responsePayload &#x3D; await response.Content.ReadAsStringAsync();</span><br><span class="line">                body &#x3D; new Response(new JRaw(responsePayload));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            var bodyBytes &#x3D; Encoding.UTF8.GetBytes(JsonConvert.SerializeObject(body, _settings));</span><br><span class="line">            httpContext.Response.Headers.AddOrReplaceHeaderKey(&quot;Content-Length&quot;, bodyBytes.Length.ToString());</span><br><span class="line">            await httpContext.Response.Body.WriteAsync(bodyBytes);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://github.com/neuecc/Utf8Json" target="_blank" rel="noopener">Utf8Json</a></p><p><a href="https://michaelscodingspot.com/the-battle-of-c-to-json-serializers-in-net-core-3/" target="_blank" rel="noopener">The Battle of C# to JSON Serializers in .NET Core 3</a></p><p><a href="https://stackoverflow.com/questions/56379096/re-use-memory-from-string-to-byte-array-conversion-with-arraypool-in-c" target="_blank" rel="noopener">Re-use memory from String to byte array conversion with ArrayPool in C#?</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;近期在对部门的crm系统进行服务化改造，服务化改造过程中，选择了ocelot作为api网关。各个服务的response到达ocelot之后，
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Async/Await是如何导致死锁的</title>
    <link href="https://loremipsumsharp.github.io/2021/04/03/Await&amp;Await%E6%98%AF%E5%A6%82%E4%BD%95%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81%E7%9A%84/"/>
    <id>https://loremipsumsharp.github.io/2021/04/03/Await&amp;Await%E6%98%AF%E5%A6%82%E4%BD%95%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81%E7%9A%84/</id>
    <published>2021-04-03T05:40:09.000Z</published>
    <updated>2021-04-02T17:55:05.211Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在使用Async/Await的过程中，经常出现原因不明的死锁，感觉代码写的没啥问题，但是程序就是卡住了，为了明白这个问题，必须知道async/await的相关原理</p><h2 id="当程序遇到await关键字后会怎么处理"><a href="#当程序遇到await关键字后会怎么处理" class="headerlink" title="当程序遇到await关键字后会怎么处理"></a>当程序遇到await关键字后会怎么处理</h2><p>当程序遇到await的关键字后，会做以下事件：</p><ol><li>将await关键字后面的相关操作注册为一个回调</li><li>释放当前线程T</li><li>如果SynchronizationContext.Current不为null，那么在步骤1的回调将通过SynchronizationContext.Post去执行（最终是步骤2的线程T去执行这段代码）</li><li>如果SynchronizationContext.Current为null，那么在步骤1的回调将会通过线程池里面的线程去执行</li></ol><h3 id="为什么会产生死锁"><a href="#为什么会产生死锁" class="headerlink" title="为什么会产生死锁"></a>为什么会产生死锁</h3><p>如下图所示：<br><a href="https://imgtu.com/i/cZt6sJ" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/04/02/cZt6sJ.png" alt="cZt6sJ.png"></a></p><ol><li>在UI线程我们调用了Wait()或者.Result，这个时候UI线程会等待异步结果</li><li>I/O线程异步操作结束后，根据以上描述，I/O线程需要SynchronizationContext.Post来继续执行await后面的逻辑，谁来执行？必然是UI线程，但是UI线程仍然在等待异步的结果，这个时候I/O线程和UI线程会出现相互等待导致死锁产生</li></ol><h3 id="如何避免死锁"><a href="#如何避免死锁" class="headerlink" title="如何避免死锁"></a>如何避免死锁</h3><p>如下图所示：</p><p><a href="https://imgtu.com/i/cmL6oD" target="_blank" rel="noopener"><img src="https://z3.ax1x.com/2021/04/03/cmL6oD.md.png" alt="cmL6oD.md.png"></a></p><p>使用<code>ConfigureAwait</code>,使用ConfigureAwait，回调会通过线程池中的线程去执行，而不是SynchronizationContext关联线程(UI线程)，所以解决了这个主要矛盾，就没有死锁了</p><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>由于async/await的底层使用了SynchronizationContext，SynchronizationContext有多种实现（console，gui，web）。在.NET FRAMEWORK环境下进行了实验，不仅在winform，在MVC中，在异步方法中进行同步调用，也会产生死锁。<br>但是在.NET CORE中，由于取消了SynchronizationContext，在异步方法中直接进行同步调用是没有问题的，可以放心调用，但是还是不建议这样做</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://tooslowexception.com/the-danger-of-asyncawait-and-result-in-one-picture/" target="_blank" rel="noopener">The danger of async/await and .Result in one picture</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;在使用Async/Await的过程中，经常出现原因不明的死锁，感觉代码写的没啥问题，但是程序就是卡住了，为了明白这个问题，必须知道async
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>使用dotnet template engine创建项目模板</title>
    <link href="https://loremipsumsharp.github.io/2021/03/01/%E4%BD%BF%E7%94%A8dotnet%20template%20engine%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E6%A8%A1%E6%9D%BF/"/>
    <id>https://loremipsumsharp.github.io/2021/03/01/%E4%BD%BF%E7%94%A8dotnet%20template%20engine%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E6%A8%A1%E6%9D%BF/</id>
    <published>2021-02-28T17:21:04.291Z</published>
    <updated>2021-02-28T17:21:58.954Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>dotnet sdk安装后默认配套了若干开发模板，使用dotnet new 命令可以让开发者快速通过开发模板搭建项目。这些内置的开发模板基本可以满足日常的开发需求，但是对于一些特定场景，比如开发者想在Abp的基础上快速搭建项目，那么必须利用 <a href="https://github.com/dotnet/templating" target="_blank" rel="noopener">dotnet template engine</a>    来进行模板的定制化开发</p><p>其实在dotnet core出来之前，比较流行的的代码自动生成的方式是利用Visual Studio内置的 <a href="https://docs.microsoft.com/en-us/visualstudio/modeling/code-generation-and-t4-text-templates?view=vs-2019" target="_blank" rel="noopener">T4模板引擎</a>  如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;#@ template debug&#x3D;&quot;true&quot; hostSpecific&#x3D;&quot;true&quot; #&gt;</span><br><span class="line">&lt;#@ output extension&#x3D;&quot;.cs&quot; #&gt;</span><br><span class="line">&lt;#@ Assembly Name&#x3D;&quot;System.Core&quot; #&gt;</span><br><span class="line">&lt;#@ Assembly Name&#x3D;&quot;System.Windows.Forms&quot; #&gt;</span><br><span class="line">&lt;#@ assembly name&#x3D;&quot;EnvDTE&quot; #&gt;  </span><br><span class="line">&lt;#@ import namespace&#x3D;&quot;EnvDTE&quot; #&gt;  </span><br><span class="line">&lt;#@ import namespace&#x3D;&quot;System&quot; #&gt;</span><br><span class="line">&lt;#@ import namespace&#x3D;&quot;System.IO&quot; #&gt;</span><br><span class="line">&lt;#@ import namespace&#x3D;&quot;System.Diagnostics&quot; #&gt;</span><br><span class="line">&lt;#@ import namespace&#x3D;&quot;System.Linq&quot; #&gt;</span><br><span class="line">&lt;#@ import namespace&#x3D;&quot;System.Collections&quot; #&gt;</span><br><span class="line">&lt;#@ import namespace&#x3D;&quot;System.Collections.Generic&quot; #&gt; </span><br><span class="line">&lt;#&#x2F;&#x2F;修改using #&gt;</span><br><span class="line">using AAM.ProductManagement.Core.Models.ProductManagement;</span><br><span class="line">using AAM.ProductManagement.Core.IRepository;</span><br><span class="line">using AAM.Repository.EntityFramework;</span><br><span class="line">&lt;#&#x2F;&#x2F;修改命名空间#&gt;</span><br><span class="line">namespace AAM.ProductManagement.Repository</span><br><span class="line">&#123;</span><br><span class="line">&lt;#</span><br><span class="line">   &#x2F;&#x2F; insert your template code here the template code will be syntax highlighted </span><br><span class="line">   &#x2F;&#x2F; and you will have intellisense for all namespaces in the full edition</span><br><span class="line">   string solutionsPath &#x3D; Host.ResolveAssemblyReference(&quot;$(SolutionDir)&quot;);  </span><br><span class="line">   &#x2F;&#x2F;修改此处路径即可生成实体</span><br><span class="line">   string modelDir&#x3D;solutionsPath+&quot;\\AAM.ProductManagement.Core\\Models\\ProductManagement\\&quot;;</span><br><span class="line">   string [] filesPaths&#x3D;Directory.GetFiles(modelDir,&quot;*&quot;,SearchOption.AllDirectories);</span><br><span class="line"></span><br><span class="line">    foreach (var item in filesPaths)</span><br><span class="line">    &#123;</span><br><span class="line">FileInfo file&#x3D;new FileInfo(item);</span><br><span class="line">string className&#x3D;file.Name.Replace(&quot;.cs&quot;,&quot;&quot;);</span><br><span class="line">if(className.EndsWith(&quot;Context&quot;)) continue;</span><br><span class="line">#&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public partial class &lt;#&#x3D; className #&gt;Repository: RepositoryBase&lt;&lt;#&#x3D; className #&gt;&gt;, I&lt;#&#x3D; className #&gt;Repository</span><br><span class="line">&#123;</span><br><span class="line">public &lt;#&#x3D; className #&gt;Repository(IProductManagementUnitOfWork unitOfWork):base(unitOfWork)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;#</span><br><span class="line">&#125;</span><br><span class="line">#&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这是一个用于快速生成仓储代码的模板。模板代码看起来相当复杂，如果不熟悉T4的语法，基本上是无法看懂，并且这种模板是无法直接调试的，你压根不知道你写的有没有问题，只有把整个模板渲染出来后才再编译一下才知道有没有问题。</p><p>总结一下，2个问题：</p><ol><li>调试不方便</li><li>有一定维护成本及学习成本</li></ol><p>为了解决上述问题，dotnet template engine用了另外一种思路：</p><p><strong>模板即代码</strong></p><p>你开发的模板首先必须是一个可以编译运行的代码，其次他才是一个模板。</p><h2 id="模板配置"><a href="#模板配置" class="headerlink" title="模板配置"></a>模板配置</h2><h3 id="前置工作"><a href="#前置工作" class="headerlink" title="前置工作"></a>前置工作</h3><p>每一个模板项目的根目录都必须有一个.template.config目录,再这个目录下面必须有一个template.json配置问题，如下：</p><table><thead><tr><th>Member</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>$schema</code></td><td>URI</td><td>The JSON schema for the <em>template.json</em> file. Editors that support JSON schemas enable JSON-editing features when the schema is specified. For example, <a href="https://code.visualstudio.com/" target="_blank" rel="noopener">Visual Studio Code</a> requires this member to enable IntelliSense. Use a value of <code>http://json.schemastore.org/template</code>.</td></tr><tr><td><code>author</code></td><td>string</td><td>The author of the template.</td></tr><tr><td><code>classifications</code></td><td>array(string)</td><td>Zero or more characteristics of the template that a user might use to find the template when searching for it. The classifications also appear in the <em>Tags</em> column when it appears in a list of templates produced by using the `dotnet new -l</td></tr><tr><td><code>identity</code></td><td>string</td><td>A unique name for this template.</td></tr><tr><td><code>name</code></td><td>string</td><td>The name for the template that users should see.</td></tr><tr><td><code>shortName</code></td><td>string</td><td>A default shorthand name for selecting the template that applies to environments where the template name is specified by the user, not selected via a GUI. For example, the short name is useful when using templates from a command prompt with CLI commands.</td></tr><tr><td><code>sourceName</code></td><td>string</td><td>The name in the source tree to replace with the name the user specifies. The template engine will look for any occurrence of the <code>sourceName</code> mentioned in the config file and replace it in file names and file contents. The value to be replaced with can be given using the <code>-n</code> or <code>--name</code> options while running a template. If no name is specified, the current directory is used.</td></tr><tr><td><code>preferNameDirectory</code></td><td>boolean</td><td>Indicates whether to create a directory for the template if name is specified but an output directory is not set (instead of creating the content directly in the current directory). The default value is false.</td></tr></tbody></table><p>这个是template.json配置中各个字段的简要说明，下面会对几个关键字段进行介绍</p><h3 id="sourceName"><a href="#sourceName" class="headerlink" title="sourceName"></a>sourceName</h3><p>如果将sourceName定义为AAA，那么在这个模板中所有以打头AAA文件名或包含AAA文本内容都会被自动替换掉，如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet new -n BBB</span><br></pre></td></tr></table></figure><p>那么 AAA会被替换为BBB，相关文件也会被重命名。一般来讲，sourceName的值就是模板文件中的csproj文件名或者sln文件名</p><h3 id="preferNameDirectory"><a href="#preferNameDirectory" class="headerlink" title="preferNameDirectory"></a>preferNameDirectory</h3><p>这个值一般会配置为true，eg：如果我在CCC目录下执行dotnet new命令，相当于 dotnet new  -n CCC</p><h3 id="symbol-特殊变量替换"><a href="#symbol-特殊变量替换" class="headerlink" title="symbol 特殊变量替换"></a>symbol 特殊变量替换</h3><p>上述两点并没有彻底解决变量替换的问题，我们需要让一些我们自己定义的变量也能够被替换掉，这个时候需要使用symbol配置,</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&quot;symbols&quot;: &#123;</span><br><span class="line">        &quot;protoPackage&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;parameter&quot;,</span><br><span class="line">            &quot;replaces&quot;: &quot;_ProtoPackage_&quot;,</span><br><span class="line">            &quot;datatype&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;isRequired&quot;: true,</span><br><span class="line">            &quot;description&quot;: &quot;Provide the proto package name&quot;,</span><br><span class="line">            &quot;FileRename&quot;: &quot;_ProtoPackage_&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;protoService&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;parameter&quot;,</span><br><span class="line">            &quot;replaces&quot;: &quot;_ProtoService_&quot;,</span><br><span class="line">            &quot;datatype&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;isRequired&quot;: true,</span><br><span class="line">            &quot;description&quot;: &quot;Provide the proto service name&quot;,</span><br><span class="line">            &quot;FileRename&quot;: &quot;_ProtoService_&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">syntax &#x3D; &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">option csharp_namespace &#x3D; &quot;AAA&quot;;</span><br><span class="line"></span><br><span class="line">package _ProtoPackage_;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; The service definition.</span><br><span class="line">service _ProtoService_ &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如上所示，通过定义symbol变量可以将grpc proto文件的报名和服务名替换掉</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>只用上述的三个配置参数，个人可以满足90%的场景需求，模板定制，无非就是变量替换，对于一些其他的场景微软官方也提供了相应的<a href="https://github.com/dotnet/dotnet-template-samples" target="_blank" rel="noopener">例子</a></p><h2 id="模板发布、安装、卸载"><a href="#模板发布、安装、卸载" class="headerlink" title="模板发布、安装、卸载"></a>模板发布、安装、卸载</h2><p>一般说来，模板开发完后我们会讲模板存放到内部的nuget服务器，为此，新建另外一个新的项目，来对模板文件打包，注意这里我们新建一个新的项目仅仅是为了将我们的模板内容传到nuget服务器，这个新建项目不是模板。<br>eg，项目结构如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">project_folder</span><br><span class="line">│   MyDotnetTemplates.csproj</span><br><span class="line">│</span><br><span class="line">└───templates</span><br><span class="line">    ├───mytemplate1</span><br><span class="line">    │   │   console.cs</span><br><span class="line">    │   │   readme.txt</span><br><span class="line">    │   │</span><br><span class="line">    │   └───.template.config</span><br><span class="line">    │           template.json</span><br><span class="line">    │</span><br><span class="line">    └───mytemplate2</span><br><span class="line">        │   otherfile.cs</span><br><span class="line">        │</span><br><span class="line">        └───.template.config</span><br><span class="line">                template.json</span><br></pre></td></tr></table></figure><p>MyDotnetTemplates.csproj内容如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;Project Sdk&#x3D;&quot;Microsoft.NET.Sdk&quot;&gt;</span><br><span class="line"></span><br><span class="line">  &lt;PropertyGroup&gt;</span><br><span class="line">    &lt;PackageType&gt;Template&lt;&#x2F;PackageType&gt;</span><br><span class="line">    &lt;PackageVersion&gt;1.0&lt;&#x2F;PackageVersion&gt;</span><br><span class="line">    &lt;PackageId&gt;AdatumCorporation.Utility.Templates&lt;&#x2F;PackageId&gt;</span><br><span class="line">    &lt;Title&gt;AdatumCorporation Templates&lt;&#x2F;Title&gt;</span><br><span class="line">    &lt;Authors&gt;Me&lt;&#x2F;Authors&gt;</span><br><span class="line">    &lt;Description&gt;Templates to use when creating an application for Adatum Corporation.&lt;&#x2F;Description&gt;</span><br><span class="line">    &lt;PackageTags&gt;dotnet-new;templates;contoso&lt;&#x2F;PackageTags&gt;</span><br><span class="line">    &lt;TargetFramework&gt;netstandard2.0&lt;&#x2F;TargetFramework&gt;</span><br><span class="line"></span><br><span class="line">    &lt;IncludeContentInPack&gt;true&lt;&#x2F;IncludeContentInPack&gt;</span><br><span class="line">    &lt;IncludeBuildOutput&gt;false&lt;&#x2F;IncludeBuildOutput&gt;</span><br><span class="line">    &lt;ContentTargetFolders&gt;content&lt;&#x2F;ContentTargetFolders&gt;</span><br><span class="line">  &lt;&#x2F;PropertyGroup&gt;</span><br><span class="line"></span><br><span class="line">  &lt;ItemGroup&gt;</span><br><span class="line">    &lt;Content Include&#x3D;&quot;templates\**\*&quot; Exclude&#x3D;&quot;templates\**\bin\**;templates\**\obj\**&quot; &#x2F;&gt;</span><br><span class="line">    &lt;Compile Remove&#x3D;&quot;**\*&quot; &#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;ItemGroup&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;Project&gt;</span><br></pre></td></tr></table></figure><p>templates存发的是模板内容，用户如果执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet new -i AdatumCorporation.Utility.Template</span><br></pre></td></tr></table></figure><p>那么就会获得模板，<br>同理,通过以下命令可以删除模板内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet new -u AdatumCorporation.Utility.Template</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://devblogs.microsoft.com/dotnet/how-to-create-your-own-templates-for-dotnet-new/" target="_blank" rel="noopener">how to create your own templates for dotnet new</a></p><p><a href="https://github.com/dotnet/docs/edit/master/docs/core/tools/custom-templates.md" target="_blank" rel="noopener">custom-templates</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;dotnet sdk安装后默认配套了若干开发模板，使用dotnet new 命令可以让开发者快速通过开发模板搭建项目。这些内置的开发模板基本
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>如何Swashbuckle可以动态的增加EndPoint</title>
    <link href="https://loremipsumsharp.github.io/2020/12/23/%E5%A6%82%E4%BD%95Swashbuckle%E5%8F%AF%E4%BB%A5%E5%8A%A8%E6%80%81%E7%9A%84%E5%A2%9E%E5%8A%A0EndPoint/"/>
    <id>https://loremipsumsharp.github.io/2020/12/23/%E5%A6%82%E4%BD%95Swashbuckle%E5%8F%AF%E4%BB%A5%E5%8A%A8%E6%80%81%E7%9A%84%E5%A2%9E%E5%8A%A0EndPoint/</id>
    <published>2020-12-23T05:40:09.000Z</published>
    <updated>2021-02-24T19:15:26.735Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h2><p>不得不说<a href="https://github.com/Burgyn/MMLib.SwaggerForOcelot" target="_blank" rel="noopener">MMLib.SwaggerForOcelot</a>这个Ocelot Swagger插件是真的好用，可以很方便的集成下游服务的swagger.json到网关之中，极大的简化了客户端的调试工作。但是这个插件有一个致命的缺陷，那就是无法动态的支持下游结点。也就是说如果下游增加一个新的结点，如果你想把这个结点swagger带出来的话，那么就必须重启ocelot。<br><a href="https://github.com/domaindrivendev/Swashbuckle.AspNetCore/issues/1093" target="_blank" rel="noopener">这个issue</a>也提到了这个问题，作者大概的意思就是说，没办法实现，要改的东西太多了，那么究竟有没有办法实现这个动态加载swagger的功能呢？答案是有</p><h2 id="分析问题"><a href="#分析问题" class="headerlink" title="分析问题"></a>分析问题</h2><p>先回忆一下我们平时我们集成swagger的常见写法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public void ConfigureServices(IServiceCollection services)</span><br><span class="line">&#123;</span><br><span class="line">     services.AddSwaggerGen(c &#x3D;&gt; .....);</span><br><span class="line">&#125;</span><br><span class="line"> public void Configure(IApplicationBuilder app, IWebHostEnvironment env)</span><br><span class="line"> &#123;</span><br><span class="line">       app.UseSwagger();</span><br><span class="line">       app.UseSwaggerUI(options &#x3D;&gt;</span><br><span class="line">       &#123;</span><br><span class="line">          options.SwaggerEndpoint(&quot;&#x2F;swagger&#x2F;v1&#x2F;swagger.json&quot;, &quot;XXX API V1&quot;);</span><br><span class="line">       &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>翻一下Swashbuckle的源码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public static IApplicationBuilder UseSwaggerUI(</span><br><span class="line">         this IApplicationBuilder app,</span><br><span class="line">         Action&lt;SwaggerUIOptions&gt; setupAction &#x3D; null)</span><br><span class="line">     &#123;</span><br><span class="line">         var options &#x3D; new SwaggerUIOptions();</span><br><span class="line">         if (setupAction !&#x3D; null)</span><br><span class="line">         &#123;</span><br><span class="line">             setupAction(options);</span><br><span class="line">         &#125;</span><br><span class="line">         else</span><br><span class="line">         &#123;</span><br><span class="line">             options &#x3D; app.ApplicationServices.GetRequiredService&lt;IOptions&lt;SwaggerUIOptions&gt;&gt;().Value;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         app.UseMiddleware&lt;SwaggerUIMiddleware&gt;(options);</span><br><span class="line"></span><br><span class="line">         return app;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p>注意到 SwaggerUIMiddleware的构造函数：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class SwaggerUIMiddleware</span><br><span class="line">      public SwaggerUIMiddleware(</span><br><span class="line">          RequestDelegate next,</span><br><span class="line">          IHostingEnvironment hostingEnv,</span><br><span class="line">          ILoggerFactory loggerFactory,</span><br><span class="line">          SwaggerUIOptions options)</span><br><span class="line">      &#123;</span><br><span class="line">          _options &#x3D; options ?? new SwaggerUIOptions();</span><br><span class="line"></span><br><span class="line">          _staticFileMiddleware &#x3D; CreateStaticFileMiddleware(next, hostingEnv, loggerFactory, options);</span><br><span class="line"></span><br><span class="line">          _jsonSerializerOptions &#x3D; new JsonSerializerOptions();</span><br><span class="line">          _jsonSerializerOptions.PropertyNamingPolicy &#x3D; JsonNamingPolicy.CamelCase;</span><br><span class="line">          _jsonSerializerOptions.IgnoreNullValues &#x3D; true;</span><br><span class="line">          _jsonSerializerOptions.Converters.Add(new JsonStringEnumConverter(JsonNamingPolicy.CamelCase, false));</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><p>那么无法使用dynamic endpoint的原因很明显，因为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.UseMiddleware&lt;SwaggerUIMiddleware&gt;(options);</span><br></pre></td></tr></table></figure><p>上面这句话本质上是把这个SwaggerUIMiddleware注册成一个单例，也就是说他的构造函数只会执行一次。那么你后续取到的endpoint必然就是一个“静态”的东西，那么解决这个主要矛盾就行了</p><h3 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h3><p>这里只是阐述思路，具体的实践方法可以自己去尝试：</p><p>首先我们通过一个scope configurer，每一个http请求都会触发swaggeruioptions的重新config</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">services.AddScoped&lt;IConfigureOptions&lt;SwaggerUIOptions&gt;, SwaggerUIOptionsConfigure&gt;();</span><br></pre></td></tr></table></figure><p>这样一来可以让SwaggerUIOptions动态的变化</p><p>然后，我们必须把SwaggerUIMiddleware替换掉，也就是说，我们没必要这样写：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.UseSwagger();</span><br><span class="line">          app.UseSwaggerUI(options &#x3D;&gt;</span><br><span class="line">          &#123;</span><br><span class="line">             options.SwaggerEndpoint(&quot;&#x2F;swagger&#x2F;v1&#x2F;swagger.json&quot;, &quot;XXX API V1&quot;);</span><br><span class="line">          &#125;);</span><br></pre></td></tr></table></figure><p>我们可以开发一个新的中间件来替换掉把SwaggerUIMiddleware，eg:RenderSwaggerUI</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> public class RenderSwaggerUI : IMiddleware</span><br><span class="line"> &#123;</span><br><span class="line">   public RenderSwaggerUI(IWebHostEnvironment hostingEnv,</span><br><span class="line">            ILoggerFactory loggerFactory,</span><br><span class="line">            IOptionsSnapshot&lt;SwaggerUIOptions&gt; swaggerUIOptions,</span><br><span class="line">            IOptionsSnapshot&lt;List&lt;RouteOptions&gt;&gt; routes,</span><br><span class="line">            IOptionsSnapshot&lt;SwaggerForOcelotUIOptions&gt; swaggerForOcelotUIOptions,</span><br><span class="line">            IOptionsSnapshot&lt;List&lt;SwaggerEndPointOptions&gt;&gt; swaggerEndPoints,</span><br><span class="line">            IHttpClientFactory httpClientFactory,</span><br><span class="line">            ISwaggerJsonTransformer swaggerJsonTransformer, ISwaggerServiceDiscoveryProvider swaggerServiceDiscoveryProvider)</span><br><span class="line">        &#123;</span><br><span class="line">            this.hostingEnv &#x3D; hostingEnv;</span><br><span class="line">            this.loggerFactory &#x3D; loggerFactory;</span><br><span class="line">            this.swaggerUIOptions &#x3D; swaggerUIOptions.Value;</span><br><span class="line">            this.swaggerForOcelotUIOptions &#x3D; swaggerForOcelotUIOptions.Value;</span><br><span class="line">            this.httpClientFactory &#x3D; httpClientFactory;</span><br><span class="line">            this.swaggerJsonTransformer &#x3D; swaggerJsonTransformer;</span><br><span class="line">            this.swaggerEndPoints &#x3D; swaggerEndPoints.Value;</span><br><span class="line">            this.routes &#x3D; routes.Value;</span><br><span class="line">            this.swaggerServiceDiscoveryProvider &#x3D; swaggerServiceDiscoveryProvider;</span><br><span class="line">        &#125;</span><br><span class="line">    public async Task InvokeAsync(HttpContext context, RequestDelegate next)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">            var swaggerUIMiddleware &#x3D; new SwaggerUIMiddleware(next, this.hostingEnv, this.loggerFactory, this.swaggerUIOptions);</span><br><span class="line">            await swaggerUIMiddleware.Invoke(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意到这里RenderSwaggerUI实现IMiddleware，目的是让这个中间件被自动注册成一个scope中间件，每次都会执行构造函数.然后手动 new 一个 swaggerUIMiddleware并Invoke</p><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>Swashbuckle的dynamic endpoint是可以实现的，只不过比较绕，这种方法不是最优解，但是可以解决问题。期待后续作者解决这个问题。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-5.0" target="_blank" rel="noopener">Dependency injection in ASP.NET Core</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;问题背景&quot;&gt;&lt;a href=&quot;#问题背景&quot; class=&quot;headerlink&quot; title=&quot;问题背景&quot;&gt;&lt;/a&gt;问题背景&lt;/h2&gt;&lt;p&gt;不得不说&lt;a href=&quot;https://github.com/Burgyn/MMLib.SwaggerForOcelot&quot;
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>rxjs中tap,map,switchmap的区别</title>
    <link href="https://loremipsumsharp.github.io/2020/10/26/rxjs%E4%B8%ADtap,map,switchmap%E7%9A%84%E5%8C%BA%E5%88%AB/"/>
    <id>https://loremipsumsharp.github.io/2020/10/26/rxjs%E4%B8%ADtap,map,switchmap%E7%9A%84%E5%8C%BA%E5%88%AB/</id>
    <published>2020-10-25T17:52:23.830Z</published>
    <updated>2020-10-25T19:35:42.198Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在前端三大框架angular,react,vue中，angular是唯一一个对rxjs进行了深度集成的框架。rxjs通过大量内置operator，极大的简化了前端对事件流的处理。</p><p>对于一个.NET后端开发来说，上手rxjs不算难事，rxjs的operator都能在Linq上面找到对应的原型，<br>所以说对于有志于成为全栈的.NET开发，angular是一个不错的选择。</p><p>在angular开发过程中，tap,map,switchmap（经常被用来做限流）这三个operator的出场率很高，但由于这三个operator的命名很相似，经常容易搞混。这里简单介绍下这三个operator的区别</p><h3 id="tap"><a href="#tap" class="headerlink" title="tap"></a>tap</h3><p>tap，并不会返回一个新的observable，只是对observable的stream进行预处理，如在调试过程中，我们经常会用tap把stream中的元素先打印出来，观测处理前和处理后的结果。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import &#123; from &#125; from &quot;rxjs&quot;;</span><br><span class="line">import &#123; tap &#125; from &quot;rxjs&#x2F;operators&quot;;</span><br><span class="line"></span><br><span class="line">from([1, 2, 3])</span><br><span class="line">  .pipe(tap(item &#x3D;&gt;  &#x2F;* do something *&#x2F;))</span><br><span class="line">  .subscribe(item &#x3D;&gt; console.log(item));</span><br></pre></td></tr></table></figure><p>tap类似于Rx.NET中的do operator</p><h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><p>map，对input stream进行处理，并返回一个新的observable</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import &#123; from &#125; from &#39;rxjs&#39;;</span><br><span class="line">import &#123; map &#125; from &#39;rxjs&#x2F;operators&#39;;</span><br><span class="line"></span><br><span class="line">from([1, 2, 3])</span><br><span class="line">  .pipe(map((item) &#x3D;&gt; item + 2))</span><br><span class="line">  .subscribe((item) &#x3D;&gt; console.log(item));</span><br></pre></td></tr></table></figure><p>map类似于Rx.NET中的select operator</p><h3 id="switchMap"><a href="#switchMap" class="headerlink" title="switchMap"></a>switchMap</h3><p>将一个内嵌的observable做flatten处理。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import &#123; from &#125; from &#39;rxjs&#39;;</span><br><span class="line">import &#123; map &#125; from &#39;rxjs&#x2F;operators&#39;;</span><br><span class="line"></span><br><span class="line">from([1, 2, 3])</span><br><span class="line">  observable as return value.</span><br><span class="line"> itself is a new observable now,</span><br><span class="line">  .pipe(map((item) &#x3D;&gt; methodWhichReturnsObservable(item)))</span><br><span class="line">  .subscribe((item) &#x3D;&gt; console.log(item));</span><br></pre></td></tr></table></figure><p>在上述代码中如果methodWhichReturnsObservable也是返回一个observable，那么console.log(item) 打印出来的item并不是一个number，而是一个observable。</p><p>为了处理这一种情况，只需将map改成switchmap</p><p>switchmap类似于Rx.NET中的selectmany</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import &#123; from &#125; from &quot;rxjs&quot;;</span><br><span class="line">import &#123; switchMap &#125; from &quot;rxjs&#x2F;operators&quot;;</span><br><span class="line"></span><br><span class="line">from([1, 2, 3])</span><br><span class="line">  .pipe(switchMap(item &#x3D;&gt; methodWhichReturnsObservable(item))</span><br><span class="line">  .subscribe(resultItem &#x3D;&gt; console.log(resultItem));</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://reactivex.io/documentation/operators.html" target="_blank" rel="noopener">Rx Operators</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;在前端三大框架angular,react,vue中，angular是唯一一个对rxjs进行了深度集成的框架。rxjs通过大量内置operat
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Grpc Channel没有关闭而导致的内存泄露问题排查</title>
    <link href="https://loremipsumsharp.github.io/2020/09/22/GrpcChannel%E6%B2%A1%E6%9C%89%E6%AD%A3%E5%B8%B8%E5%85%B3%E9%97%AD%E8%80%8C%E5%AF%BC%E8%87%B4%E7%9A%84%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
    <id>https://loremipsumsharp.github.io/2020/09/22/GrpcChannel%E6%B2%A1%E6%9C%89%E6%AD%A3%E5%B8%B8%E5%85%B3%E9%97%AD%E8%80%8C%E5%AF%BC%E8%87%B4%E7%9A%84%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/</id>
    <published>2020-09-22T00:23:22.413Z</published>
    <updated>2021-04-02T16:50:49.081Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>日前上线了一个用于统计统计用户活跃度的服务，上线之后，出现了内存泄漏的问题，通过lldb对程序的core dump进行分析，最终找到了泄漏的原因</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>服务上线后，出现大量告警，提示服务器内存不足，grafana监控提示服务内存泄漏：</p><p><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/WeChat%20Screenshot_20200922084321.png" alt=""></p><p>使用将线上的服务的内存dump下来，继续观察：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;share&#x2F;dotnet&#x2F;shared&#x2F;Microsoft.NETCore.App&#x2F;2.1.1&#x2F;createdump -u 1</span><br></pre></td></tr></table></figure><p>通过lldb加载core dump文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lldb-3.9 dotnet -c &#x2F;tmp&#x2F;20290824_activevalue_coredump  -o &quot;plugin load &#x2F;usr&#x2F;share&#x2F;dotnet&#x2F;shared&#x2F;Microsoft.NETCore.App&#x2F;2.1.1&#x2F;libsosplugin.so&quot;</span><br></pre></td></tr></table></figure><p>查看堆大小：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eeheap -gc</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/WeChat%20Screenshot_20200927023535.png" alt=""></p><p>进一步查看当前堆各个类型的对象数量<br><code>dumpheap -stat</code></p><p>提示有大量Grpc对象积压.</p><p>进一步，对项目的各个接口进行压测,对内存进行三次采样：</p><p>第一次采样77MB:</p><p><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/dasdasdas.png" alt=""></p><p>第二次采样82MB:</p><p><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/2323fadas.png" alt=""></p><p>第三次采样 86MB：</p><p><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/adasdasgdfasdas.png" alt=""></p><p>VS内存分析工具提示GRPC内存对象一直没有得到有效的控制，数量不断上升<br>在采样过程中手动进行GC，只是下降53个对象，大量channel仍然驻留内存:</p><p><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/dasdasfdvfsdvsdf.png" alt=""></p><p><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/dasdascas.png" alt=""></p><p>根据上述采样分析，可以肯定业务代码中存在grpc channel正常关闭的场景。</p><p>进一步查看代码发现：<br><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/WeChat%20Screenshot_20200927024147.png" alt=""></p><p>每一次通过grpc client调用其他服务的时候会直接常见Channel，而不是复用之前的Channel，并且创建后的Channel没有关闭</p><p>修复这部分代码后，线上内存使用率恢复正常</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://github.com/grpc/grpc-java/issues/3268" target="_blank" rel="noopener">Channel creation best practice</a></p><p><a href="https://docs.microsoft.com/zh-cn/aspnet/core/grpc/performance?view=aspnetcore-5.0" target="_blank" rel="noopener">Performance best practices with gRPC</a>！！！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;日前上线了一个用于统计统计用户活跃度的服务，上线之后，出现了内存泄漏的问题，通过lldb对程序的core dump进行分析，最终找到了泄漏的
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Union查询性能优</title>
    <link href="https://loremipsumsharp.github.io/2020/09/21/Union%E6%9F%A5%E8%AF%A2%E6%80%A7%E8%83%BD%E4%BC%98/"/>
    <id>https://loremipsumsharp.github.io/2020/09/21/Union%E6%9F%A5%E8%AF%A2%E6%80%A7%E8%83%BD%E4%BC%98/</id>
    <published>2020-09-20T18:58:22.193Z</published>
    <updated>2020-09-20T19:27:56.385Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Union的工作原理"><a href="#Union的工作原理" class="headerlink" title="Union的工作原理"></a>Union的工作原理</h2><p>假设现在有两个集合A：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">blue</span><br><span class="line">green</span><br><span class="line">gray</span><br><span class="line">black</span><br></pre></td></tr></table></figure><p>集合B：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">red</span><br><span class="line">green</span><br><span class="line">yellow</span><br><span class="line">blue</span><br></pre></td></tr></table></figure><p>现在对集合A、B进行Union操作，首先Mysql会创建一个临时表来暂存A ∪ B = C<br>Step1(将A的元素和B的元素都添加到C中)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">black</span><br><span class="line">blue</span><br><span class="line">blue</span><br><span class="line">gray</span><br><span class="line">green</span><br><span class="line">green</span><br><span class="line">red</span><br><span class="line">yellow</span><br></pre></td></tr></table></figure><p>接下来对C进行去重，得到：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">black</span><br><span class="line">blue</span><br><span class="line">gray</span><br><span class="line">green</span><br><span class="line">red</span><br><span class="line">yellow</span><br></pre></td></tr></table></figure><h2 id="如何优化"><a href="#如何优化" class="headerlink" title="如何优化"></a>如何优化</h2><h3 id="使用Union-All"><a href="#使用Union-All" class="headerlink" title="使用Union All"></a>使用Union All</h3><p>对一个大数据集进行去重操作需要很高的算力，当业务场景可以接收重复结果的情况下，使用Union All，Union All不会对结果集进行去重，这个时候可以减少Union去重带来的性能损耗</p><h3 id="将查询条件放在Union的子查询中"><a href="#将查询条件放在Union的子查询中" class="headerlink" title="将查询条件放在Union的子查询中"></a>将查询条件放在Union的子查询中</h3><p>如果不将查询条件放在子查询之中，这个时候默认Union将各个子查询的结果全部查出来，然后放到一个临时表中，再对临时表进行过滤，这个时候，没办法利用到Mysql的索引，不利于性能的提高。所以使用Union操作的时候要尽量将查询条件，排序条件放在子查询之中。<br>另外需要注意的一点是，如果直接对子查询进行Order By操作，Mysql会提示<code>Incorrect usage of UNION and ORDER BY</code>,如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM t1 WHERE username LIKE &#39;l%&#39; ORDER BY score ASC</span><br><span class="line">UNION</span><br><span class="line">SELECT * FROM t1 WHERE username LIKE &#39;%m%&#39; ORDER BY score ASC</span><br></pre></td></tr></table></figure><p>解决的办法就是用一个括号将子查询包起来，再进行Union操作：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(SELECT * FROM t1 WHERE username LIKE &#39;l%&#39; ORDER BY sroce ASC)</span><br><span class="line">UNION</span><br><span class="line">(SELECT * FROM t1 WHERE username LIKE &#39;%m%&#39; ORDER BY score ASC)</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.jb51.net/article/99842.htm" target="_blank" rel="noopener">MySQL中union和order by同时使用的实现方法</a></p><p><a href="https://www.iheavy.com/2013/06/13/how-to-optimize-mysql-union-for-high-speed/" target="_blank" rel="noopener">How to Optimize MySQL UNION For High Speed</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Union的工作原理&quot;&gt;&lt;a href=&quot;#Union的工作原理&quot; class=&quot;headerlink&quot; title=&quot;Union的工作原理&quot;&gt;&lt;/a&gt;Union的工作原理&lt;/h2&gt;&lt;p&gt;假设现在有两个集合A：&lt;/p&gt;
&lt;figure class=&quot;highlig
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>ThreadLocal的应用</title>
    <link href="https://loremipsumsharp.github.io/2020/09/14/ThreadLocal%E5%9C%A8RabbitMq%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/"/>
    <id>https://loremipsumsharp.github.io/2020/09/14/ThreadLocal%E5%9C%A8RabbitMq%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/</id>
    <published>2020-09-13T16:29:00.493Z</published>
    <updated>2020-09-13T17:29:49.768Z</updated>
    
    <content type="html"><![CDATA[<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="Thread-Local-Storage"><a href="#Thread-Local-Storage" class="headerlink" title="Thread-Local Storage"></a>Thread-Local Storage</h3><p>在日常开发过程中，你有时候可能会希望一些对象，变量可以做到线程隔离，不相互影响。为了实现这个需求，.NET引入了一个被称为<code>Thread-Local Storage</code> 的概念，通过<code>Thread-Local Storage</code>，变量、对象无需重复定义，也不需要添加锁，就可以实现在线程之间的相互隔离</p><h3 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal<T></h3><p><code>ThreadLocal</code> 是 <code>Thread-Local Storage</code>的一个具体实现，一个<code>ThreadLocal</code>的对象字段，在不通线程之中可以做到相互隔离</p><p>示例代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">class Program</span><br><span class="line">    &#123;</span><br><span class="line">        static void Main(string[] args)</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F; contruct on this thread</span><br><span class="line">            ThreadLocalDemo demoObject &#x3D; new ThreadLocalDemo();</span><br><span class="line">            demoObject.PrintCounterValue();</span><br><span class="line">            demoObject.IncrementCounter();</span><br><span class="line">            demoObject.PrintCounterValue();</span><br><span class="line"></span><br><span class="line">          </span><br><span class="line">            var resetEvent &#x3D; new ManualResetEvent(false);</span><br><span class="line">            ThreadPool.QueueUserWorkItem(state &#x3D;&gt;</span><br><span class="line">            &#123;</span><br><span class="line">             </span><br><span class="line">                ((ThreadLocalDemo)state).PrintCounterValue();</span><br><span class="line">                ((ThreadLocalDemo)state).IncrementCounter();</span><br><span class="line">                ((ThreadLocalDemo)state).PrintCounterValue();</span><br><span class="line"></span><br><span class="line">              </span><br><span class="line">                var demo &#x3D; new ThreadLocalDemo();</span><br><span class="line">                demo.IncrementCounter();</span><br><span class="line">                demo.PrintCounterValue();</span><br><span class="line"></span><br><span class="line">                resetEvent.Set();</span><br><span class="line">            &#125;, demoObject);</span><br><span class="line"></span><br><span class="line">            resetEvent.WaitOne();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class ThreadLocalDemo</span><br><span class="line">    &#123;</span><br><span class="line">        private ThreadLocal&lt;int&gt; counter;</span><br><span class="line">        private static ThreadLocal&lt;int&gt; staticCounter;</span><br><span class="line">        private static Guid staticId;</span><br><span class="line">        private Guid id;</span><br><span class="line"></span><br><span class="line">        static ThreadLocalDemo()</span><br><span class="line">        &#123;</span><br><span class="line">            staticCounter &#x3D; new ThreadLocal&lt;int&gt;();</span><br><span class="line">            staticId &#x3D; Guid.NewGuid();</span><br><span class="line">            Console.WriteLine($&quot;Static constructor:&quot;);</span><br><span class="line">            Console.WriteLine($&quot;thread id: &#123;Thread.CurrentThread.ManagedThreadId&#125;, type id: &#123;staticId&#125;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public ThreadLocalDemo()</span><br><span class="line">        &#123;</span><br><span class="line">            counter &#x3D; new ThreadLocal&lt;int&gt;();</span><br><span class="line">            id &#x3D; Guid.NewGuid();</span><br><span class="line">            Console.WriteLine($&quot;Constructor: thread id: &#123;Thread.CurrentThread.ManagedThreadId&#125;, object id &#123;id&#125;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void IncrementCounter()</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(&quot;Incrementing both local and static counters&quot;);</span><br><span class="line">            counter.Value++;</span><br><span class="line">            staticCounter.Value++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void PrintCounterValue()</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(&quot;Printing current values&quot;);</span><br><span class="line">            Console.WriteLine($&quot;thread id: &#123;Thread.CurrentThread.ManagedThreadId&#125;, object id &#123;id&#125;, counter: &#123;counter.Value&#125;, static Counter: &#123;staticCounter.Value&#125;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>输出结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Static constructor:</span><br><span class="line">thread id: 1, type id: 220a1d54-0d32-4961-9f19-9da5a625eaeb</span><br><span class="line">Constructor: thread id: 1, object id a655a69c-4c16-4a6e-88b3-c339f247d895</span><br><span class="line">Printing current values</span><br><span class="line">thread id: 1, object id a655a69c-4c16-4a6e-88b3-c339f247d895, counter: 0, static Counter: 0</span><br><span class="line">Incrementing both local and static counters</span><br><span class="line">Printing current values</span><br><span class="line">thread id: 1, object id a655a69c-4c16-4a6e-88b3-c339f247d895, counter: 1, static Counter: 1</span><br><span class="line">Printing current values</span><br><span class="line">thread id: 4, object id a655a69c-4c16-4a6e-88b3-c339f247d895, counter: 0, static Counter: 0</span><br><span class="line">Incrementing both local and static counters</span><br><span class="line">Printing current values</span><br><span class="line">thread id: 4, object id a655a69c-4c16-4a6e-88b3-c339f247d895, counter: 1, static Counter: 1</span><br><span class="line">Constructor: thread id: 4, object id 3175a74e-255c-4934-ae9f-e9790d05e486</span><br><span class="line">Incrementing both local and static counters</span><br><span class="line">Printing current values</span><br><span class="line">thread id: 4, object id 3175a74e-255c-4934-ae9f-e9790d05e486, counter: 1, static Counter: 2</span><br></pre></td></tr></table></figure><p>上述代码，所在demoObj的实例计数器在Thread 1 为 1，但当进入到Thread 4 的时候，实例计数器被重置为0，也就是说<code>counter</code>的值受线程影响，不同的线程有不同的拷贝</p><h2 id="具体应用"><a href="#具体应用" class="headerlink" title="具体应用"></a>具体应用</h2><p><code>ThreadLocal</code>目前在自己维护的项目中应用的比较少，大多数情况会选择在线程上下文中定义一个新的变量，而不是去引用外部的<code>ThreadLocal</code>变量，目前唯一用到的就是在RabbitMQ。</p><p>根据RabbitMQ的官方文档，IModel对象不是一个线程安全的对象，每一个每一个线程应该有且只有一个IModel,建多了也没意义：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Don’t share channels between threads</span><br><span class="line">Use one channel per thread in your application, and make sure that you don’t share channels between threads as most clients don’t make channels thread-safe.</span><br><span class="line"></span><br><span class="line">CloudAMQP allows you to scale your instances to meet demand while providing mechanisms to troubleshoot leaks. If you have any questions, you can reach out to us at support@cloudamqp.com</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public interface IMessagePublisher</span><br><span class="line">  &#123;</span><br><span class="line">      Task PublishAsync&lt;TMessage&gt;(TMessage message);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public class MessagePublisher : IMessagePublisher</span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line">      private readonly ISerializer _serializer;</span><br><span class="line">      public MessagePublisher(ISerializer serializer, IConnectionFactory connectionFactory)</span><br><span class="line">      &#123;</span><br><span class="line">          _serializer &#x3D; serializer;</span><br><span class="line">          _channel &#x3D; new ThreadLocal&lt;IModel&gt;(() &#x3D;&gt; connectionFactory.CreateConnection().CreateModel());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      public async Task PublishAsync&lt;TMessage&gt;(TMessage message)</span><br><span class="line">      &#123;</span><br><span class="line">          var type &#x3D; typeof(TMessage);</span><br><span class="line">          var exchangeName &#x3D; GetExchangeName(type);</span><br><span class="line">          var routingKey &#x3D; GetRoutingKey(type);</span><br><span class="line">          var data &#x3D; _serializer.Serialize(message);</span><br><span class="line"></span><br><span class="line">          await PublishAsync(exchangeName, routingKey, data);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   services.AddSingleton&lt;IMessagePublisher, MessagePublisher&gt;();</span><br></pre></td></tr></table></figure><p>通过上述代码，虽然IMessagePublisher是单例，但channel也可以实现做到每一个线程唯一，最大程度的减少了对象的创建</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cloudamqp.com/blog/2019-11-13-the-relationship-between-connections-and-channels-in-rabbitmq.html" target="_blank" rel="noopener">What is the relationship between connections and channels in RabbitMQ?</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;基本概念&quot;&gt;&lt;a href=&quot;#基本概念&quot; class=&quot;headerlink&quot; title=&quot;基本概念&quot;&gt;&lt;/a&gt;基本概念&lt;/h2&gt;&lt;h3 id=&quot;Thread-Local-Storage&quot;&gt;&lt;a href=&quot;#Thread-Local-Storage&quot; cla
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>基于 kubernetes 的动态 jenkins slave的自动化发布</title>
    <link href="https://loremipsumsharp.github.io/2020/08/10/%E5%9F%BA%E4%BA%8E%20kubernetes%20%E7%9A%84%E5%8A%A8%E6%80%81%20jenkins%20slave%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8F%91%E5%B8%83/"/>
    <id>https://loremipsumsharp.github.io/2020/08/10/%E5%9F%BA%E4%BA%8E%20kubernetes%20%E7%9A%84%E5%8A%A8%E6%80%81%20jenkins%20slave%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8F%91%E5%B8%83/</id>
    <published>2020-08-09T17:08:32.123Z</published>
    <updated>2020-08-09T17:44:57.435Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>前几天在youtube上面看了一个关于如何<a href="https://www.youtube.com/watch?v=eMOzF_xAm7w&t=3s" target="_blank" rel="noopener">使用jenkins实现k8s的CI/CD</a>,现对视频中相关的配置方法进行了文字性的总结，并在此基础上引入了sematic release实现版本号的自动生成</p><h2 id="jenkins-动态-slave"><a href="#jenkins-动态-slave" class="headerlink" title="jenkins 动态 slave"></a>jenkins 动态 slave</h2><p>持续构建与发布是我们日常工作中必不可少的一个步骤，目前大多公司都采用 Jenkins 集群来搭建符合需求的 CI/CD 流程，然而传统的 Jenkins Slave 一主多从方式会存在一些痛点，比如：</p><p>主 Master 发生单点故障时，整个流程都不可用了<br>每个 Slave 的配置环境不一样，来完成不同语言的编译打包等操作，但是这些差异化的配置导致管理起来非常不方便，维护起来也是比较费劲<br>资源分配不均衡，有的 Slave 要运行的 job 出现排队等待，而有的 Slave 处于空闲状态<br>资源有浪费，每台 Slave 可能是物理机或者虚拟机，当 Slave 处于空闲状态时，也不会完全释放掉资源。<br>正因为上面的这些种种痛点，我们渴望一种更高效更可靠的方式来完成这个 CI/CD 流程，而 Docker 虚拟化容器技术能很好的解决这个痛点，又特别是在 Kubernetes 集群环境下面能够更好来解决上面的问题，下图是基于 Kubernetes 搭建 Jenkins 集群的简单示意图：<br><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/clipboard.png" alt="image"></p><h2 id="helm"><a href="#helm" class="headerlink" title="helm"></a>helm</h2><p>Kubernetes是容器集群管理系统，每个成功的软件平台都有一个优秀的打包系统，比如 Debian、Ubuntu 的 apt，Redhat、Centos 的 yum。而 Helm 则是 Kubernetes 上的包管理器。helm相当于一个应用商店，将一个在云上部署的应用相关的组件全部打包起来，进行安装、升级、管理等，如下图所示：<br><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/clipboard%20(1).png" alt="image"></p><h3 id="HelmClient"><a href="#HelmClient" class="headerlink" title="HelmClient"></a>HelmClient</h3><p>是用户命令行工具，其主要负责如下：</p><ul><li>本地 chart 开发</li><li>仓库管理</li><li>与 Tiller sever 交互</li><li>发送预安装的 chart</li><li>查询 release 信息</li><li>要求升级或卸载已存在的 release</li></ul><h3 id="TillerServer"><a href="#TillerServer" class="headerlink" title="TillerServer"></a>TillerServer</h3><p>是一个部署在 Kubernetes集群内部的 server，其与 Helm client、Kubernetes API server 进行交互。Tiller server 主要负责如下：</p><ul><li>监听来自 Helm client 的请求</li><li>通过 chart 及其配置构建一次发布</li><li>安装 chart 到 Kubernetes集群，并跟踪随后的发布</li><li>通过与 Kubernetes交互升级或卸载 chart</li><li>简单的说，client 管理 charts，而 server 管理发布 release</li></ul><h2 id="Semantic-Release"><a href="#Semantic-Release" class="headerlink" title="Semantic Release"></a>Semantic Release</h2><p>是一个自动生成版本号,发布日志的工具。semantic release按照<br><a href="https://semver.org/" target="_blank" rel="noopener">Semantic Versioning</a>的规范,根据用户的<a href="https://github.com/angular/angular/blob/master/CONTRIBUTING.md" target="_blank" rel="noopener">commit message</a>来确定下一个版本号</p><h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h2><h3 id="安装Kubernetes插件"><a href="#安装Kubernetes插件" class="headerlink" title="安装Kubernetes插件"></a>安装Kubernetes插件</h3><p><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/clipboard%20(2).png" alt="image"></p><h3 id="配置kubernetes插件"><a href="#配置kubernetes插件" class="headerlink" title="配置kubernetes插件"></a>配置kubernetes插件</h3><p><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/clipboard%20(3).png" alt="image"></p><p>1.Kubernetes URL，API SERVER的URL</p><p>2.Kubernetes server certificate key，证书密钥,可以在 ~/.kube/config 文件中获得</p><p>3.Kubernetes Namespace，Slave Pod所在的Kubernetes namespace</p><p>4.Credentials，访问API SERVER时使用的Token</p><p>5.Jenkins URL，Jenkins Master节点的URL</p><p>6.Jenkins Tunnel，Jenkins Tunnel地址</p><p>7.授权,namespace与3保持一致</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins</span><br><span class="line">---</span><br><span class="line">kind: Role</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;pods&quot;]</span><br><span class="line">  verbs: [&quot;create&quot;,&quot;delete&quot;,&quot;get&quot;,&quot;list&quot;,&quot;patch&quot;,&quot;update&quot;,&quot;watch&quot;]</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;pods&#x2F;exec&quot;]</span><br><span class="line">  verbs: [&quot;create&quot;,&quot;delete&quot;,&quot;get&quot;,&quot;list&quot;,&quot;patch&quot;,&quot;update&quot;,&quot;watch&quot;]</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;pods&#x2F;log&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;,&quot;list&quot;,&quot;watch&quot;]</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;secrets&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;]</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1beta1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: jenkins</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: jenkins</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding jenkins --clusterrole cluster-admin --serviceaccount&#x3D;&lt;namespace&gt;:jenkins</span><br></pre></td></tr></table></figure><h1 id="发布配置"><a href="#发布配置" class="headerlink" title="发布配置"></a>发布配置</h1><h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/clipboard%20(4).png" alt="image"></p><ol><li>charts目录，存放helm 模板文件</li><li>src，项目代码</li><li>.releaserc.json，semantci-release配置文件</li><li>CHANGELOG.MD，发布日志，由semantic-release自动生成</li><li>Jenkinsfile，Jenkins 流水线的定义文件</li></ol><h2 id="gitlab-集成"><a href="#gitlab-集成" class="headerlink" title="gitlab 集成"></a>gitlab 集成</h2><p><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/clipboard%20(5).png" alt="image"></p><h2 id="创建Pipeline任务"><a href="#创建Pipeline任务" class="headerlink" title="创建Pipeline任务"></a>创建Pipeline任务</h2><h3 id="配置pipeline环境变量"><a href="#配置pipeline环境变量" class="headerlink" title="配置pipeline环境变量"></a>配置pipeline环境变量</h3><p><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/clipboard%20(6).png" alt="image"></p><h3 id="配置gitlab-trigger"><a href="#配置gitlab-trigger" class="headerlink" title="配置gitlab trigger"></a>配置gitlab trigger</h3><p><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/clipboard%20(7).png" alt="image"></p><p>注意：需要勾选<strong>ci-skip</strong>选项,防止自动生成changelog时重复触发CI</p><h3 id="配置Pipeline"><a href="#配置Pipeline" class="headerlink" title="配置Pipeline"></a>配置Pipeline</h3><p><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/clipboard%20(8).png" alt="image"></p><h2 id="集成semantic-release"><a href="#集成semantic-release" class="headerlink" title="集成semantic-release"></a>集成semantic-release</h2><pre><code>{    &quot;branch&quot;: &quot;master&quot;,    &quot;plugins&quot;: [        &quot;@semantic-release/commit-analyzer&quot;,        &quot;@semantic-release/release-notes-generator&quot;,        [            &quot;@semantic-release/changelog&quot;,            {                &quot;changelogFile&quot;: &quot;CHANGELOG.md&quot;,                &quot;changelogTitle&quot;: &quot;# Changelog | Consul Kube Sync&quot;            }        ],        [            &quot;@semantic-release/git&quot;,            {                &quot;assets&quot;: [                    &quot;CHANGELOG.md&quot;                ],                &quot;message&quot;: &quot;[ci-skip]&quot;            }        ],        [            &quot;@semantic-release/exec&quot;,            {                &quot;prepareCmd&quot;: &quot;echo ${nextRelease.version} &gt; .next-version&quot;            }        ]    ]}</code></pre><h2 id="jenkinsfile"><a href="#jenkinsfile" class="headerlink" title="jenkinsfile"></a>jenkinsfile</h2><p>请参考备注示例项目</p><h1 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h1><p><a href="https://github.com/LoremipsumSharp/JenkinsKubernetesAutomation" target="_blank" rel="noopener">示例项目</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;前几天在youtube上面看了一个关于如何&lt;a href=&quot;https://www.youtube.com/watch?v=eMOzF_xA
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>DNS的一些入门的基本概念</title>
    <link href="https://loremipsumsharp.github.io/2020/08/05/DNS%E7%9A%84%E4%B8%80%E4%BA%9B%E5%85%A5%E9%97%A8%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/"/>
    <id>https://loremipsumsharp.github.io/2020/08/05/DNS%E7%9A%84%E4%B8%80%E4%BA%9B%E5%85%A5%E9%97%A8%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/</id>
    <published>2020-08-04T18:49:52.854Z</published>
    <updated>2020-08-04T18:50:24.297Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Authoritative-Servers"><a href="#Authoritative-Servers" class="headerlink" title="Authoritative Servers"></a>Authoritative Servers</h2><p>DNS Servers can be configured to host more than one domain. A server can be primary for one domain, and secondary for another. The term authoritative refers to any DNS servers that has a complete copy of the domain’s information, whether it was entered by an administrator or transferred from a primary server. Thus, a secondary server can and should be authoritative for any domain for which it performs secondary authoritative resolution.</p><h2 id="Authoritative-Responses"><a href="#Authoritative-Responses" class="headerlink" title="Authoritative Responses"></a>Authoritative Responses</h2><p>Any response to a DNS query that originates from a DNS server with a complete copy of the zone file is said to be an ‘authoritative response’. What complicates matters is that DNS servers cache the answers they receive. If a DNS server has an SOA record, it fills in a field in the response that signals that the server queried is authoritative for the domain and that the answer is authoritative. Any DNS server external to that domain that retrieved the authoritative response will cache that answer. The next time the server is queried, it will say that the answer it is giving is authoritative, even though it is not authoritative for that domain.</p><p>In other words, it IS possible for a DNS server that is NOT an authoritative server for a domain to give an ‘authoritative response’ to a DNS query for a domain it does not serve.</p><p>Non-authoritative responses come from DNS servers that have cached an answer for a given host, but received that information from a server that is not authoritative for the domain.</p><h2 id="Kind-of-DNS-Server"><a href="#Kind-of-DNS-Server" class="headerlink" title="Kind of DNS Server"></a>Kind of DNS Server</h2><p>DNS architecture works on an inverted tree structure. At the top of the inverted tree is the 13 DNS root servers, and then comes the TLD(Top Level Domain) servers, and beneath the TLD servers comes the authoritative DNS server for a particular domain(sometimes called as secondary domains.)</p><h2 id="Kind-of-DNS-Query"><a href="#Kind-of-DNS-Query" class="headerlink" title="Kind of DNS Query"></a>Kind of DNS Query</h2><p><a href="https://www.slashroot.in/difference-between-iterative-and-recursive-dns-query" target="_blank" rel="noopener">difference between iterative and recursive dns query</a></p><h2 id="Dns-Zone"><a href="#Dns-Zone" class="headerlink" title="Dns Zone"></a>Dns Zone</h2><p><a href="https://www.slashroot.in/what-dns-zone-file-complete-tutorial-zone-file-and-its-contents" target="_blank" rel="noopener">What is a DNS ZONE file: A Complete Tutorial on zone file and its contents</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Authoritative-Servers&quot;&gt;&lt;a href=&quot;#Authoritative-Servers&quot; class=&quot;headerlink&quot; title=&quot;Authoritative Servers&quot;&gt;&lt;/a&gt;Authoritative Servers&lt;/
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>.NET内存管理中需要掌握的一些基本概念(持续更新）</title>
    <link href="https://loremipsumsharp.github.io/2020/07/16/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E4%B8%AD%E9%9C%80%E8%A6%81%E6%8E%8C%E6%8F%A1%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/"/>
    <id>https://loremipsumsharp.github.io/2020/07/16/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E4%B8%AD%E9%9C%80%E8%A6%81%E6%8E%8C%E6%8F%A1%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/</id>
    <published>2020-07-16T05:40:09.000Z</published>
    <updated>2020-07-18T17:28:14.616Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Working-set"><a href="#Working-set" class="headerlink" title="Working set"></a>Working set</h2><p>this is a part of virtual address space that currently resides in the physical memory. This means it can be further divided into:</p><ul><li>Private working set - consists of committed (private) pages in the<br>physical memory.</li><li>Shareable working set - consists of all shareable pages (no matter if they are actually shared or not)</li><li>Shared working set - consists of shareable pages that are actually<br>shared with other processes.</li><li>Private bytes - all committed (private) pages - both in the physical and paged memory.</li><li>Virtual bytes - both committed (private) and reserved memory</li><li>Paged bytes - part of the virtual bytes that are stored in the page file.<br><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/WeChat%20Screenshot_20200716021336.png" alt=""></li></ul><h2 id="Value-Types"><a href="#Value-Types" class="headerlink" title="Value Types"></a>Value Types</h2><p>We have two categories of value types in the Common Language Specification:</p><ul><li>structs - there are many built-in integral types (char, byte, integer, and so forth), floating-point types, and bool. And, of course, the user can define its own structs.</li><li>enumerations - they are basically an extension of integral types, becoming a type that consists of a set of named constants. From the memory-management point of view, they are just integral types so we won’t deal with them in this book at all as they are in fact structs also internally.</li></ul><h2 id="使用struct的好处"><a href="#使用struct的好处" class="headerlink" title="使用struct的好处"></a>使用struct的好处</h2><ol><li>struct类型是Value Type，所以struct有可能被分配在stack上，分配在stack上可以避免因为分配的heap上所带来的gc</li><li>strcut在同等条件下，所需的内存比class要小（这个是因为struct不需要存放相关的元信息）</li><li>struct更加符合data locality的要求,refernce type 总是包含两个额外的字段，给定一个64B的cache line,refernce type命中缓存的概率远低于strcut<br><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/WeChat%20Screenshot_20200716025533.png" alt=""><br><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/WeChat%20Screenshot_20200716025454.png" alt=""></li></ol><h2 id="Lexical-Scope"><a href="#Lexical-Scope" class="headerlink" title="Lexical Scope"></a>Lexical Scope</h2><p>In the simplest words,it defines areas of code in which the given variable is visiable</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Working-set&quot;&gt;&lt;a href=&quot;#Working-set&quot; class=&quot;headerlink&quot; title=&quot;Working set&quot;&gt;&lt;/a&gt;Working set&lt;/h2&gt;&lt;p&gt;this is a part of virtual address 
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>在Kafka流处理中自定义时间窗口</title>
    <link href="https://loremipsumsharp.github.io/2020/07/05/Kafka%E6%B5%81%E5%A4%84%E7%90%86%E4%B8%AD%E8%87%AA%E5%AE%9A%E4%B9%89%E6%97%B6%E9%97%B4%E7%AA%97%E5%8F%A3/"/>
    <id>https://loremipsumsharp.github.io/2020/07/05/Kafka%E6%B5%81%E5%A4%84%E7%90%86%E4%B8%AD%E8%87%AA%E5%AE%9A%E4%B9%89%E6%97%B6%E9%97%B4%E7%AA%97%E5%8F%A3/</id>
    <published>2020-07-05T08:16:56.269Z</published>
    <updated>2020-07-05T16:37:09.176Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题的背景"><a href="#问题的背景" class="headerlink" title="问题的背景"></a>问题的背景</h2><p>近期有一个项目在做重构，一部分业务要迁移到Kafka上面来进一步提高性能，需求是这样的：根据一定规则量化用户行为并实时统计用户活跃度，每一个统计周期1天，即24小时。</p><p>咋一看，这个问题很好处理，直接使用Kafka流处理中的时间窗口函数，每一个窗口的长度为24小时，每次接收到一条消息就通过Kafka Stream Api进行聚合，时间窗口可以直接使用Tumbling Windows来解决。但是产品还提出了另外一个需求，就是统计时间范围，从每天的22:00 ~ 第二天的21:59</p><p>这种情况，无法用Tumbling windows来解决，因为Tumbling windows定义的时间范围是从每天的（00:00~23:59)，Kafka的相关文档也没又提到这个场景需要如何处理。</p><h2 id="实现方法"><a href="#实现方法" class="headerlink" title="实现方法"></a>实现方法</h2><p>实际上，这个需求可以通过一下两种方法：</p><ol><li>通过Timeextractor来重写时间</li><li>自定义时间窗口</li></ol><h3 id="通过TimeExtractor来重写时间戳"><a href="#通过TimeExtractor来重写时间戳" class="headerlink" title="通过TimeExtractor来重写时间戳"></a>通过TimeExtractor来重写时间戳</h3><p>既然产品需求是从每天的22:00 ~ 第二天的21:59，那么我可以在原有的时间戳的基础上加两个小时来补全Tumbling windows所定义的时间范围</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class UserEventTimestampExtractor implements TimestampExtractor &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public long extract(ConsumerRecord&lt;Object, Object&gt; record, long partitionTime) &#123;</span><br><span class="line">        UserEvent userEvent &#x3D; (UserEvent) record.value();</span><br><span class="line">        return userEvent.getCreateTime().plusHours(2)</span><br><span class="line">        .toInstant(ZoneOffset.UTC).toEpochMilli();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="自定义时间窗口（建议使用，更加直观）"><a href="#自定义时间窗口（建议使用，更加直观）" class="headerlink" title="自定义时间窗口（建议使用，更加直观）"></a>自定义时间窗口（建议使用，更加直观）</h3><p>继承 Windows<TimeWindow> 并重写 windowsFor 方法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Map&lt;Long, TimeWindow&gt; windowsFor(final long timestamp) &#123;</span><br><span class="line">    final Instant instant &#x3D; Instant.ofEpochMilli(timestamp);</span><br><span class="line"></span><br><span class="line">    final ZonedDateTime zonedDateTime &#x3D; instant.atZone(zoneId);</span><br><span class="line">    final ZonedDateTime startTime &#x3D; zonedDateTime.getHour() &gt;&#x3D; startHour ? zonedDateTime.truncatedTo(ChronoUnit.DAYS).withHour(startHour) : zonedDateTime.truncatedTo(ChronoUnit.DAYS).minusDays(1).withHour(startHour);</span><br><span class="line">    final ZonedDateTime endTime &#x3D; startTime.plusDays(1);</span><br><span class="line"></span><br><span class="line">    final Map&lt;Long, TimeWindow&gt; windows &#x3D; new LinkedHashMap&lt;&gt;();</span><br><span class="line">    windows.put(toEpochMilli(startTime), new TimeWindow(toEpochMilli(startTime), toEpochMilli(endTime)));</span><br><span class="line">    return windows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的starhour取22</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://github.com/confluentinc/kafka-streams-examples/blob/5.5.0-post/src/test/java/io/confluent/examples/streams/window/DailyTimeWindows.java" target="_blank" rel="noopener">kafka-streams-examples</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;问题的背景&quot;&gt;&lt;a href=&quot;#问题的背景&quot; class=&quot;headerlink&quot; title=&quot;问题的背景&quot;&gt;&lt;/a&gt;问题的背景&lt;/h2&gt;&lt;p&gt;近期有一个项目在做重构，一部分业务要迁移到Kafka上面来进一步提高性能，需求是这样的：根据一定规则量化用户行为并实
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>如何安装特定版本的dotnet sdk</title>
    <link href="https://loremipsumsharp.github.io/2020/06/25/%E5%A6%82%E4%BD%95%E5%AE%89%E8%A3%85%E7%89%B9%E5%AE%9A%E7%89%88%E6%9C%AC%E7%9A%84dotnet%20sdk/"/>
    <id>https://loremipsumsharp.github.io/2020/06/25/%E5%A6%82%E4%BD%95%E5%AE%89%E8%A3%85%E7%89%B9%E5%AE%9A%E7%89%88%E6%9C%AC%E7%9A%84dotnet%20sdk/</id>
    <published>2020-06-25T13:47:41.999Z</published>
    <updated>2020-06-28T06:45:59.851Z</updated>
    
    <content type="html"><![CDATA[<p>在ubuntu上通过package mananger安装dotnet sdk默认情况下会自动安装最新版的,但有些时候我们并不希望安装最新版，而是安装一个特定的版本，这个时候可以通过一下三种方法：</p><ol><li>执行<a href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-install-script" target="_blank" rel="noopener">dotnet-install</a> 并指定特定版本号，如:</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;dotnet-install.sh --version 3.1.201</span><br></pre></td></tr></table></figure><ol start="2"><li>手动下载二进制tar包并解压（比较麻烦）</li><li>通过package mananger进行安装(官网目前没有介绍这种方法)</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#首先查看目前可安装的包版本</span><br><span class="line">apt policy dotnet-sdk-3.1</span><br><span class="line">#安装指定版本</span><br><span class="line">apt-get install  dotnet-sdk-3.1&#x3D;3.1.201-1</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在ubuntu上通过package mananger安装dotnet sdk默认情况下会自动安装最新版的,但有些时候我们并不希望安装最新版，而是安装一个特定的版本，这个时候可以通过一下三种方法：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;执行&lt;a href=&quot;https://docs.mi
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Spring Data MongoDb 通过Gradle集成QureyDSL的配置方法</title>
    <link href="https://loremipsumsharp.github.io/2020/05/17/Spring%20Data%20MongoDb%20%E9%80%9A%E8%BF%87Gradle%E9%9B%86%E6%88%90QureyDSL%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95/"/>
    <id>https://loremipsumsharp.github.io/2020/05/17/Spring%20Data%20MongoDb%20%E9%80%9A%E8%BF%87Gradle%E9%9B%86%E6%88%90QureyDSL%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95/</id>
    <published>2020-05-17T15:39:20.000Z</published>
    <updated>2020-05-17T15:39:06.656Z</updated>
    
    <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>QueryDSL是一个通用的查询框架，专注于通过Java API构建类型安全的SQL查询。目前在 Github 上的发布的 Release 版本已经多达 251 个版本，目前最新版是 4.3.1 ，并且由 Querydsl Google组 和 StackOverflow 两个团队提供支持。QueryDSL 是一个框架，可用于构造静态类型的类似SQL的查询。可以通过诸如 QueryDSL 之类的 API 构造查询，而不是将查询编写为内联字符串或将其外部化为XML文件。</p><p>例如，与简单字符串相比，使用 API 的好处是</p><ul><li><p>IDE中的代码完成</p></li><li><p>几乎没有语法无效的查询</p></li><li><p>可以安全地引用域类型和属性</p></li><li><p>更好地重构域类型的更改</p></li></ul><p>目前网上能够查阅到通过gradle集成QueryDSL的资料非常少，大部分是基于Maven，基于gradle的配置方法很多都是错的（这个是由于gradle的版本升级，新版本的gradle对QueryDSL没有做到向下兼容）</p><h2 id="gradle配置方法"><a href="#gradle配置方法" class="headerlink" title="gradle配置方法"></a>gradle配置方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id &#39;org.springframework.boot&#39; version &#39;2.2.5.RELEASE&#39;</span><br><span class="line">    id &#39;io.spring.dependency-management&#39; version &#39;1.0.9.RELEASE&#39;</span><br><span class="line">    id &#39;java&#39;</span><br><span class="line">    id &quot;com.ewerk.gradle.plugins.querydsl&quot; version &quot;1.0.10&quot;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">group &#x3D; &#39;io.loremipsum&#39;</span><br><span class="line">version &#x3D; &#39;0.0.1-SNAPSHOT&#39;</span><br><span class="line">sourceCompatibility &#x3D; &#39;11&#39;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">querydsl &#123;</span><br><span class="line">    library &#x3D; &#39;com.querydsl:querydsl-apt:4.1.4&#39;</span><br><span class="line">    querydslSourcesDir &#x3D; &#39;src&#x2F;main&#x2F;querydsl&#39;</span><br><span class="line">    springDataMongo &#x3D; true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sourceSets &#123;</span><br><span class="line">    main &#123;</span><br><span class="line">        java &#123;</span><br><span class="line">            srcDirs &#x3D; [&#39;src&#x2F;main&#x2F;java&#39;, &#39;src&#x2F;main&#x2F;querydsl&#39;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 当gradle版本&gt;5.0的时候需要加上这个配置</span><br><span class="line">compileQuerydsl &#123;</span><br><span class="line">    options.annotationProcessorPath &#x3D; configurations.querydsl</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile &#39;org.springframework.boot:spring-boot-starter-data-mongodb&#39;</span><br><span class="line">    compile &#39;org.springframework.boot:spring-boot-starter-web&#39;</span><br><span class="line"></span><br><span class="line">    compile(&quot;com.querydsl:querydsl-core:4.1.4&quot;)</span><br><span class="line">    compile(&quot;com.querydsl:querydsl-mongodb:4.1.4&quot;)</span><br><span class="line">    compile(&quot;com.querydsl:querydsl-apt:4.1.4&quot;)</span><br><span class="line"></span><br><span class="line">    compile &#39;org.projectlombok:lombok&#39;</span><br><span class="line">    annotationProcessor &#39;org.projectlombok:lombok&#39;</span><br><span class="line"></span><br><span class="line">    testCompile(&#39;org.springframework.boot:spring-boot-starter-test&#39;)</span><br><span class="line">    testCompile &#39;de.flapdoodle.embed:de.flapdoodle.embed.mongo&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意上述配置mongodb的依赖必须声明为compile（如果通过spring boot initializer创建项目,这里会被声明为implementation)，否则会提示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Annotation processor &#39;org.springframework.data.mongodb.repository.support.MongoAnnotationProcessor&#39; not found</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/babycomeon/p/11605809.html" target="_blank" rel="noopener">Spring Boot （六）： 为 JPA 插上翅膀的 QueryDSL</a></p><p><a href="https://stackoverflow.com/questions/53913274/querydsl-annotation-processor-issue-after-upgrade-to-gradle-5" target="_blank" rel="noopener">Querydsl Annotation Processor issue after upgrade to Gradle 5</a></p><p><a href="https://github.com/ewerk/gradle-plugins/issues/108" target="_blank" rel="noopener">querydsl-plugin don’t work in Gradle 5.0</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;引言&quot;&gt;&lt;a href=&quot;#引言&quot; class=&quot;headerlink&quot; title=&quot;引言&quot;&gt;&lt;/a&gt;引言&lt;/h2&gt;&lt;p&gt;QueryDSL是一个通用的查询框架，专注于通过Java API构建类型安全的SQL查询。目前在 Github 上的发布的 Release 
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>使用ValueTask减少假异步代码引起的GC</title>
    <link href="https://loremipsumsharp.github.io/2020/04/27/%E4%BD%BF%E7%94%A8ValueTask%E5%87%8F%E5%B0%91%E5%81%87%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81%E5%BC%95%E8%B5%B7%E7%9A%84GC/"/>
    <id>https://loremipsumsharp.github.io/2020/04/27/%E4%BD%BF%E7%94%A8ValueTask%E5%87%8F%E5%B0%91%E5%81%87%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81%E5%BC%95%E8%B5%B7%E7%9A%84GC/</id>
    <published>2020-04-27T14:43:07.391Z</published>
    <updated>2020-04-30T04:50:56.002Z</updated>
    
    <content type="html"><![CDATA[<h2 id="async-await代码存在的问题"><a href="#async-await代码存在的问题" class="headerlink" title="async/await代码存在的问题"></a>async/await代码存在的问题</h2><p>async/await是.NET4.5引入的一个语法糖，如下所示，下面的代码首先会以同步的方法判断一个文件是否存在，如果存在，那么就会已异步的方式去读取文件的内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public async Task&lt;string&gt; ReadFileAsync(string filename)</span><br><span class="line">&#123;</span><br><span class="line">    if (!File.Exists(filename))</span><br><span class="line">        return string.Empty;</span><br><span class="line">    return await File.ReadAllTextAsync(filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过async/await开发人员可以编写更加简洁的异步代码，通过IL SPY我们可以观察到，编译器实际上将async/await转为为了一个StateMachine,如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[AsyncStateMachine(typeof(Program.&lt;ReadFileAsync&gt;d__14))]</span><br><span class="line">public Task&lt;string&gt; ReadFileAsync(string filename)</span><br><span class="line">&#123;</span><br><span class="line">    Program.&lt;ReadFileAsync&gt;d__14 &lt;ReadFileAsync&gt;d__;</span><br><span class="line">    &lt;ReadFileAsync&gt;d__.filename &#x3D; filename;</span><br><span class="line">    &lt;ReadFileAsync&gt;d__.&lt;&gt;t__builder &#x3D; AsyncTaskMethodBuilder&lt;string&gt;.</span><br><span class="line">    Create();</span><br><span class="line">    &lt;ReadFileAsync&gt;d__.&lt;&gt;1__state &#x3D; -1;</span><br><span class="line">    AsyncTaskMethodBuilder&lt;string&gt; &lt;&gt;t__builder &#x3D; &lt;ReadFileAsync&gt;d__.&lt;&gt;t__</span><br><span class="line">    builder;</span><br><span class="line">    &lt;&gt;t__builder.Start&lt;Program.&lt;ReadFileAsync&gt;d__14&gt;(ref &lt;ReadFileAsync&gt;d__);</span><br><span class="line">    return &lt;ReadFileAsync&gt;d__.&lt;&gt;t__builder.Task;</span><br><span class="line">&#125;</span><br><span class="line">[CompilerGenerated]</span><br><span class="line">[StructLayout(LayoutKind.Auto)]</span><br><span class="line">private struct &lt;ReadFileAsync&gt;d__14 : IAsyncStateMachine</span><br><span class="line">&#123;</span><br><span class="line">    void IAsyncStateMachine.MoveNext()</span><br><span class="line">    &#123;</span><br><span class="line">        int num &#x3D; this.&lt;&gt;1__state;</span><br><span class="line">        string result;</span><br><span class="line">        try</span><br><span class="line">        &#123;</span><br><span class="line">            TaskAwaiter&lt;string&gt; awaiter;</span><br><span class="line">            if (num !&#x3D; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                if (!File.Exists(this.filename))</span><br><span class="line">                &#123;</span><br><span class="line">                    result &#x3D; string.Empty;</span><br><span class="line">                    goto IL_A4;</span><br><span class="line">                &#125;</span><br><span class="line">                awaiter &#x3D; File.ReadAllTextAsync(this.filename,</span><br><span class="line">                default(CancellationToken)).GetAwaiter();</span><br><span class="line">                if (!awaiter.get_IsCompleted())</span><br><span class="line">                &#123;</span><br><span class="line">                    this.&lt;&gt;1__state &#x3D; 0;</span><br><span class="line">                    this.&lt;&gt;u__1 &#x3D; awaiter;</span><br><span class="line">                    this.&lt;&gt;t__builder.AwaitUnsafeOnCompleted&lt;TaskAwaiter</span><br><span class="line">                    &lt;string&gt;, Program.&lt;ReadFileAsync&gt;d__14&gt;(ref awaiter, ref</span><br><span class="line">                    this);</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            awaiter &#x3D; this.&lt;&gt;u__1;</span><br><span class="line">            this.&lt;&gt;u__1 &#x3D; default(TaskAwaiter&lt;string&gt;);</span><br><span class="line">            this.&lt;&gt;1__state &#x3D; -1;</span><br><span class="line">        &#125;   </span><br><span class="line">        result &#x3D; awaiter.GetResult();</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception exception)</span><br><span class="line">    &#123;</span><br><span class="line">        this.&lt;&gt;1__state &#x3D; -2;</span><br><span class="line">        this.&lt;&gt;t__builder.SetException(exception);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IL_A4:</span><br><span class="line">    this.&lt;&gt;1__state &#x3D; -2;</span><br><span class="line">    this.&lt;&gt;t__builder.SetResult(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意到上面的代码，当文件不存在的时候会执行goto语句，也就是this.&lt;&gt;t__builder.SetResult(result)，t_builder是AsyncTaskMethodBuilder<T>的一个实例，<br>我们可以看下SetResult的<a href="https://github.com/dotnet/runtime/blob/110282c71b3f7e1f91ea339953f4a0eba362a62c/src/libraries/System.Private.CoreLib/src/System/Runtime/CompilerServices/AsyncTaskMethodBuilderT.cs" target="_blank" rel="noopener">实现</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void SetResult(TResult result)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; Get the currently stored task, which will be non-null if get_Task has already been accessed.</span><br><span class="line">    &#x2F;&#x2F; If there isn&#39;t one, get a task and store it.</span><br><span class="line">    if (m_task is null)</span><br><span class="line">    &#123;</span><br><span class="line">        m_task &#x3D; GetTaskForResult(result);</span><br><span class="line">        Debug.Assert(m_task !&#x3D; null, $&quot;&#123;nameof(GetTaskForResult)&#125; should never return null&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; Slow path: complete the existing task.</span><br><span class="line">        SetExistingTaskResult(m_task, result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于此时这个时候并产生真正的异步操作，所以m_task is null 成立,查看GetTaskForResult(result)：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[MethodImpl(MethodImplOptions.AggressiveInlining)] </span><br><span class="line">&#x2F;&#x2F; method looks long, but for a given TResult it results in a relatively small amount of asm</span><br><span class="line">internal static Task&lt;TResult&gt; GetTaskForResult(TResult result)</span><br><span class="line">&#123;</span><br><span class="line">    if (null !&#x3D; (object?)default(TResult)) &#x2F;&#x2F; help the JIT avoid the value type branches for ref types</span><br><span class="line">    &#123;</span><br><span class="line">        .....</span><br><span class="line">    &#125;</span><br><span class="line">    else if (result &#x3D;&#x3D; null) &#x2F;&#x2F; optimized away for value types</span><br><span class="line">    &#123;</span><br><span class="line">        return s_defaultResultTask;</span><br><span class="line">    &#125;</span><br><span class="line">    return new Task&lt;TResult&gt;(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于string是引用类型且result不为null,所以必然会导致一个新的Task对象被创建，那么也就是说，即便不存在异步调用，也会创建一个新的Task对象，如果存在大量的假异步调用，势必会造成成大量的一代GC，从而影响程序的性能。</p><h2 id="问题的解决"><a href="#问题的解决" class="headerlink" title="问题的解决"></a>问题的解决</h2><p>为了解决上述问题，.NET CORE 2.1引入了一个新的概念，ValueTask：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public struct ValueTask&lt;TResult&gt;</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    IValueTaskSource&lt;TResult&gt;</span><br><span class="line">    internal readonly object _obj;</span><br><span class="line">    internal readonly TResult _result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用ValueTask改写ReadFile代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public async ValueTask&lt;string&gt; ReadFileAsync(string filename)</span><br><span class="line">&#123;</span><br><span class="line">    if (!File.Exists(filename))</span><br><span class="line">        return string.Empty;</span><br><span class="line">    return await File.ReadAllTextAsync(filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当调用ReadFileAsync时，可以使用ValueTask.IsCompleted来判断这个调用是不是假异步调用，如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var valueTask &#x3D; ReadFileAsync();</span><br><span class="line">if(valueTask.IsCompleted)</span><br><span class="line">&#123;</span><br><span class="line">    return valueTask.Result;</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">    return await valueTask.AsTask();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果假异步调用，IsCompleted为true，这个时候返回valueTask.Result,不会产生Task对象的分配而ValueTask本身也是一个值类型，也不会产生allocation。反之，如果是真异步调用则按照原来的逻辑去执行。</p><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>当应用程序对性能要求比较苛刻的时候并且存在大量假异步调用的情况下，可以考虑使用ValueTask来提高性能。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;async-await代码存在的问题&quot;&gt;&lt;a href=&quot;#async-await代码存在的问题&quot; class=&quot;headerlink&quot; title=&quot;async/await代码存在的问题&quot;&gt;&lt;/a&gt;async/await代码存在的问题&lt;/h2&gt;&lt;p&gt;async/
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>高并发场景下StackExchange.Redis驱动的超时问题</title>
    <link href="https://loremipsumsharp.github.io/2020/04/25/%E9%AB%98%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8BStackExchange.Redis%E9%A9%B1%E5%8A%A8%E7%9A%84%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98/"/>
    <id>https://loremipsumsharp.github.io/2020/04/25/%E9%AB%98%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8BStackExchange.Redis%E9%A9%B1%E5%8A%A8%E7%9A%84%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98/</id>
    <published>2020-04-25T05:40:09.000Z</published>
    <updated>2020-04-28T02:58:56.213Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h2><p>近期部门的大量微服务在做国际化改造。为了实现国际化需求，需要有一个支撑服务用于提供用户ip信息数据。由于是支撑服务，会产生大量调用，大概每分钟2000次的调用，为了进一步提供性能，该服务会把用户的ip信息缓存到redis以避免重复调用第三方接口获取ip数据。<br>上线前对该服务进行了压力测试，发现在高并发的场景下，会频繁发生<br><strong>StackExchange.Redis.RedisTimeoutException</strong>异常，这对于一个支撑服务来说是不可接受的。</p><h2 id="问题重现"><a href="#问题重现" class="headerlink" title="问题重现"></a>问题重现</h2><p>使用grpc压力测试工具<a href="https://github.com/bojand/ghz" target="_blank" rel="noopener">ghz</a>模拟高并发场景：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ghz 192.168.1.44:43667 --insecure \</span><br><span class="line">--proto ..&#x2F;..&#x2F;proto&#x2F;FM.Region.Client&#x2F;Region.proto \</span><br><span class="line">--call Region.RegionSrv&#x2F;GetRegionInfoDetailByIp \</span><br><span class="line"> --concurrency 400 \</span><br><span class="line">-n 1200 \</span><br><span class="line">-D  .&#x2F;ip.json</span><br></pre></td></tr></table></figure><p>1200请求，400个并发，共3轮测试</p><p>测试ip数据集如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;27.220.195.252&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;32.213.120.200&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;58.88.5.142&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;99.107.218.202&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;126.179.177.51&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;75.179.58.40&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;92.243.129.145&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;179.240.146.239&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;54.99.209.135&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;116.125.57.197&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;104.243.227.11&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;65.175.113.237&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;92.160.105.28&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;51.189.156.232&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;101.136.19.162&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;128.78.227.70&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;123.139.77.54&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;172.234.209.119&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;187.172.248.233&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;28.8.211.1&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;130.96.236.81&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;88.162.103.72&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;166.2.94.121&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;102.106.115.156&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;19.148.120.200&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;219.240.103.98&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;221.17.125.56&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;91.236.176.82&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;41.237.239.70&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;145.55.30.213&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;139.135.98.132&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;72.143.86.138&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;198.225.10.195&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;136.234.70.30&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;103.89.118.202&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;44.250.218.13&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;116.207.166.76&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;140.238.239.80&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;31.158.163.164&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;182.215.64.241&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;220.197.147.157&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;117.254.129.148&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;94.184.10.88&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;219.61.223.175&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;185.172.199.161&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;184.69.18.249&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;166.64.229.72&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;212.98.0.204&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;160.59.24.87&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;48.195.150.66&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;147.186.60.20&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;138.19.147.96&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;8.43.149.29&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;108.94.149.179&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;111.177.253.182&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;99.160.130.179&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;125.194.19.83&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;26.100.156.127&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;105.18.80.126&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;128.141.4.89&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;80.20.225.251&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;41.253.214.98&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;36.5.58.33&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;56.52.122.254&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;162.240.161.83&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;195.221.65.187&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;223.215.140.121&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;42.254.253.187&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;99.236.88.173&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;87.49.237.85&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;124.230.221.226&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;46.22.123.116&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;105.85.140.56&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;69.167.167.233&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;176.44.47.123&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;40.225.1.63&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;102.209.225.101&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;62.173.169.38&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;51.133.22.72&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;31.129.69.30&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;194.133.28.78&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;9.243.223.78&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;185.107.13.97&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;155.131.137.219&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>测试输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Summary:</span><br><span class="line">  Count:        1200</span><br><span class="line">  Total:        36.67 s</span><br><span class="line">  Slowest:      19.65 s</span><br><span class="line">  Fastest:      1.01 s</span><br><span class="line">  Average:      11.12 s</span><br><span class="line">  Requests&#x2F;sec: 32.72</span><br><span class="line"></span><br><span class="line">Response time histogram:</span><br><span class="line">  1011.354 [1]  |</span><br><span class="line">  2875.261 [8]  |∎</span><br><span class="line">  4739.167 [13] |∎</span><br><span class="line">  6603.074 [17] |∎∎</span><br><span class="line">  8466.981 [230]        |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  10330.887 [117]       |∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  12194.794 [440]       |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  14058.701 [172]       |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  15922.608 [145]       |∎∎∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  17786.514 [44]        |∎∎∎∎</span><br><span class="line">  19650.421 [7] |∎</span><br><span class="line"></span><br><span class="line">Latency distribution:</span><br><span class="line">  10%% in 8.15 s</span><br><span class="line">  25%% in 9.21 s</span><br><span class="line">  50%% in 11.17 s</span><br><span class="line">  75%% in 12.50 s</span><br><span class="line">  90%% in 14.51 s</span><br><span class="line">  95%% in 15.28 s</span><br><span class="line">  99%% in 17.24 s</span><br><span class="line"></span><br><span class="line">Status code distribution:</span><br><span class="line">  [OK]                 1194 responses</span><br><span class="line">  [DeadlineExceeded]   6 responses</span><br><span class="line"></span><br><span class="line">Error distribution:</span><br><span class="line">  [5]   rpc error: code &#x3D; DeadlineExceeded desc &#x3D; context deadline exceeded</span><br><span class="line">  [1]   rpc error: code &#x3D; DeadlineExceeded desc &#x3D; Deadline Exceeded</span><br></pre></td></tr></table></figure><p>测试输出提示请求超时，而且大量请求响应时间很不理想，查看日志发现StackExchange.Redis.RedisTimeoutException异常：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StackExchange.Redis.RedisTimeoutException: Timeout performing EVAL, inst: 5, queue: 1032, qu: 0, qs: 1032, qc: 0, wr: 0, wq: 0, in: 97489, ar: 0, clientName: , serverEndpoint: 192.168.1.44:43667, keyHashSlot: 693 (Please take a look at this article for some common client-side issues that can cause timeouts: http:\&#x2F;\&#x2F;stackexchange.github.io\&#x2F;StackExchange.Redis\&#x2F;Timeouts)\n   at StackExchange.Redis.ConnectionMultiplexer.ExecuteSyncImpl[T](Message message, ResultProcessor&#96;1 processor, ServerEndPoint server ...</span><br></pre></td></tr></table></figure><h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><p>根据<a href="https://github.com/StackExchange/StackExchange.Redis/blob/master/docs/Timeouts.md" target="_blank" rel="noopener">StackExchange.Redis官方文档</a>描述,在高并发场景下，当StackExchange.Redis的内部线程池无法满足并发要求的时候会去请求CLR的全局线程池，全局线程池的初始线程数量是根据CPU的核心数来确定的，当全局线程池的线程不够用的时候，会以500ms/per thread的速度往线程池里面添加新的线程，但这个速度在高并发场景下还是远远不够的，为此需要配置CLR线程池的最小线程数来满足高并发的场景。<br>在程序入口添加如下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ThreadPool.SetMinThreads(512, 100) &#x2F;&#x2F;worker最小线程数512,IOCP最小线程数100</span><br></pre></td></tr></table></figure><h2 id="问题验证"><a href="#问题验证" class="headerlink" title="问题验证"></a>问题验证</h2><p>配置最小线程数后再进行压力测试，测试输出如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Summary:</span><br><span class="line">  Count:        1200</span><br><span class="line">  Total:        2.66 s</span><br><span class="line">  Slowest:      2.15 s</span><br><span class="line">  Fastest:      1.99 ms</span><br><span class="line">  Average:      827.12 ms</span><br><span class="line">  Requests&#x2F;sec: 451.92</span><br><span class="line"></span><br><span class="line">Response time histogram:</span><br><span class="line">  1.987 [1]     |</span><br><span class="line">  216.449 [66]  |∎∎∎∎∎∎∎</span><br><span class="line">  430.911 [174] |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  645.373 [403] |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  859.835 [136] |∎∎∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  1074.297 [75] |∎∎∎∎∎∎∎</span><br><span class="line">  1288.759 [48] |∎∎∎∎∎</span><br><span class="line">  1503.221 [69] |∎∎∎∎∎∎∎</span><br><span class="line">  1717.683 [156]        |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  1932.145 [13] |∎</span><br><span class="line">  2146.607 [59] |∎∎∎∎∎∎</span><br><span class="line"></span><br><span class="line">Latency distribution:</span><br><span class="line">  10%% in 332.77 ms</span><br><span class="line">  25%% in 445.91 ms</span><br><span class="line">  50%% in 547.70 ms</span><br><span class="line">  75%% in 1.28 s</span><br><span class="line">  90%% in 1.68 s</span><br><span class="line">  95%% in 1.91 s</span><br><span class="line">  99%% in 2.11 s</span><br><span class="line"></span><br><span class="line">Status code distribution:</span><br><span class="line">  [OK]   1200 responses</span><br></pre></td></tr></table></figure><p>超时问题消失,并且响应时间大幅度减小</p><p>需要注意的是，如果机器配置不够（CPU跑满了)，再高并发场景下，仍然会出现超时问题。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;问题背景&quot;&gt;&lt;a href=&quot;#问题背景&quot; class=&quot;headerlink&quot; title=&quot;问题背景&quot;&gt;&lt;/a&gt;问题背景&lt;/h2&gt;&lt;p&gt;近期部门的大量微服务在做国际化改造。为了实现国际化需求，需要有一个支撑服务用于提供用户ip信息数据。由于是支撑服务，会产生大
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>记线上的一次Mysql死锁问题分析</title>
    <link href="https://loremipsumsharp.github.io/2020/03/14/%E8%AE%B0%E7%BA%BF%E4%B8%8A%E7%9A%84%E4%B8%80%E6%AC%A1Mysql%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/"/>
    <id>https://loremipsumsharp.github.io/2020/03/14/%E8%AE%B0%E7%BA%BF%E4%B8%8A%E7%9A%84%E4%B8%80%E6%AC%A1Mysql%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/</id>
    <published>2020-03-14T02:10:39.000Z</published>
    <updated>2020-04-28T02:58:16.285Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>最近上线了叫做“F币”的功能，简单说下就是系统会根据用户每天在社区的活跃行为，计算每一个用户的活跃度，最后根据用户每天的总活跃度返还相应的“F币”给用户，用户得到F币之后可以在社区兑换不同的礼品,如下图所示：<br><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/BF0B1ABB-F459-4343-BE90-5177FB6583D5.png" alt=""></p><p>在测试环境和仿真环境运行的好好的，但是上线之后经常接到用户反馈，需要多次点击才能完成领取。查看阿里云日志，提示数据库产生死锁，如下图所示：<br><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/9DF85AF7-0840-4323-9B0C-613480533A45.png" alt=""></p><h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>注意到这里有一排按钮，用户的每次点击，后台都会进行以下两个操作：</p><ol><li>更新用户余额（用户表）</li><li>生成流水记录 （用户流水记录）</li></ol><p>注：用户表和流水表存在主外键关系</p><p>以上的两个操作会放在同一个事务完成，并且由于Ef的SaveChanges并不会根据你代码执行的先后次序去更新数据库，当用户以很快的速度从左到右依次点击，存在以下可能：</p><p>T1:事务A插入流水，由于存在外键，会对user对应的行上S锁。</p><p>T2:事务B插入流水，由于存在外键，会对user对应的行上S锁。</p><p>T3:事务A更新User的余额，请求行记录的X锁，被B事务在T2的S锁阻塞</p><p>T4:事务B更新User的余额，请求行记录的X锁，被A事务在T1的S锁阻塞</p><p>至此死锁产生。</p><h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><p>用了一个比较简单+暴力的方法：领取接口直接上redis分布式锁。</p><h2 id="总结与反思"><a href="#总结与反思" class="headerlink" title="总结与反思"></a>总结与反思</h2><p>这个项目是使用DDD的思想进行开发的，自然而然地在ORM上面的选型使用了EntityFramework Code First,但是Code Firit在建表的时候会自做主张的在“多”端生成外键。对外键的使用，除开了一部分性能开销，就是上述的死锁问题，后续考虑把这部分重构为DbFirst。</p><p>另外值得一提的是，后来对这部逻辑做了压测，发现这部分代码在Sql Server跑是没问题的，因为Sql Server在插入子表的时候不会对父表记录上锁，而Mysql会对父表上锁,所以产生了死锁，天下果然没有免费午餐！</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://stackoverflow.com/questions/7335582/dbcontext-savechanges-order-of-statement-execution" target="_blank" rel="noopener">DbContext SaveChanges Order of Statement Execution</a></p><p><a href="https://bugs.mysql.com/bug.php?id=48652" target="_blank" rel="noopener">Deadlock due to Foreign Key constraint</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h2&gt;&lt;p&gt;最近上线了叫做“F币”的功能，简单说下就是系统会根据用户每天在社区的活跃行为，计算每一个用户的活跃度，最后根据用户每天的总活
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>AspNetCore2.1升级到3.1时CORS相关配置的变更</title>
    <link href="https://loremipsumsharp.github.io/2020/02/27/AspNetCore2.1%E5%8D%87%E7%BA%A7%E5%88%B03.1%E6%97%B6CORS%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%E7%9A%84%E5%8F%98%E6%9B%B4/"/>
    <id>https://loremipsumsharp.github.io/2020/02/27/AspNetCore2.1%E5%8D%87%E7%BA%A7%E5%88%B03.1%E6%97%B6CORS%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%E7%9A%84%E5%8F%98%E6%9B%B4/</id>
    <published>2020-02-27T12:05:33.000Z</published>
    <updated>2020-04-28T02:57:21.278Z</updated>
    
    <content type="html"><![CDATA[<p>本周将公司的运营系统从AspNetCore2.1升级到了AspNetCore3.1,遇到了一些坑，这里记录以下</p><h2 id="2-1的相关CORS代码"><a href="#2-1的相关CORS代码" class="headerlink" title="2.1的相关CORS代码"></a>2.1的相关CORS代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public IServiceProvider ConfigureServices(IServiceCollection services)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">        ... &#x2F;&#x2F; 省略</span><br><span class="line">        services.AddCors(option &#x3D;&gt; option.AddPolicy(&quot;corsPolicy&quot;, builders &#x3D;&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            builders.AllowCredentials().AllowAnyOrigin().AllowAnyHeader().AllowAnyMethod();</span><br><span class="line">        &#125;));</span><br><span class="line">        ... &#x2F;&#x2F; 省略</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void Configure(IApplicationBuilder app, ILoggerFactory loggerFactory, IHostingEnvironment env)</span><br><span class="line">&#123;</span><br><span class="line">    ... &#x2F;&#x2F; 省略</span><br><span class="line">    app.UseCors(&quot;corsPolicy&quot;);</span><br><span class="line">     ... &#x2F;&#x2F; 省略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果这部分代码这3.1的服务中不加任何修改，启动时提示错误：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The CORS protocol does not allow specifying a wildcard (any) origin and credentials at the same time. Configure the CORS policy by listing individual origins if credentials needs to be supported.</span><br></pre></td></tr></table></figure><p>这是由于在2.1之后,AspNetCore出于安全考虑，做了更加严格的限制，在不AllowCredentials()与AllowAnyOrigin()。</p><p>假设现在站点A存在一个恶意脚本，而站点B存在一个比较的敏感的接口（如转账）。如果站点B作为服务端使用AllowCredentials()与AllowAnyOrigin()的同源配置，此时站点A可以直接调用站点B的敏感接口并发送凭证信息（如Cookie），那么将导致用户信息被窃取。</p><h2 id="3-1的相关CORS代码"><a href="#3-1的相关CORS代码" class="headerlink" title="3.1的相关CORS代码"></a>3.1的相关CORS代码</h2><h3 id="options1-显示声明允许跨域的origin"><a href="#options1-显示声明允许跨域的origin" class="headerlink" title="options1 显示声明允许跨域的origin"></a>options1 显示声明允许跨域的origin</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">services.AddCors(option &#x3D;&gt; option.AddPolicy(&quot;corsPolicy&quot;, builders &#x3D;&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                builders.WithOrigins(&quot;http:&#x2F;&#x2F;site.com&quot;).AllowAnyHeader().AllowAnyMethod().AllowCredentials();</span><br><span class="line">            &#125;));</span><br></pre></td></tr></table></figure><h3 id="options2-使用-SetIsOriginAllowed（可以起到与AllowAnyOriginu一样的效果）"><a href="#options2-使用-SetIsOriginAllowed（可以起到与AllowAnyOriginu一样的效果）" class="headerlink" title="options2 使用 SetIsOriginAllowed（可以起到与AllowAnyOriginu一样的效果）"></a>options2 使用 SetIsOriginAllowed（可以起到与AllowAnyOriginu一样的效果）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">services.AddCors(option &#x3D;&gt; option.AddPolicy(&quot;corsPolicy&quot;, builders &#x3D;&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                builders.SetIsOriginAllowed(origin&#x3D;&gt;true).AllowAnyHeader().AllowAnyMethod().AllowCredentials(); &#x2F;&#x2F;SetIsOriginAllowed(origin&#x3D;&gt;true)允许所有origin</span><br><span class="line">            &#125;));</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;本周将公司的运营系统从AspNetCore2.1升级到了AspNetCore3.1,遇到了一些坑，这里记录以下&lt;/p&gt;
&lt;h2 id=&quot;2-1的相关CORS代码&quot;&gt;&lt;a href=&quot;#2-1的相关CORS代码&quot; class=&quot;headerlink&quot; title=&quot;2.1的相
      
    
    </summary>
    
    
    
  </entry>
  
</feed>
