<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Loremipsum Blog</title>
  <icon>https://www.gravatar.com/avatar/bcce300a816652e13f1514ef10ae2d8a</icon>
  <subtitle>Things always get worse before they get better.</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://loremipsumsharp.github.io/"/>
  <updated>2020-06-28T06:45:59.851Z</updated>
  <id>https://loremipsumsharp.github.io/</id>
  
  <author>
    <name>Loremipsum</name>
    <email>mvclogic@gmail.com</email>
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>如何安装特定版本的dotnet sdk</title>
    <link href="https://loremipsumsharp.github.io/2020/06/25/%E5%A6%82%E4%BD%95%E5%AE%89%E8%A3%85%E7%89%B9%E5%AE%9A%E7%89%88%E6%9C%AC%E7%9A%84dotnet%20sdk/"/>
    <id>https://loremipsumsharp.github.io/2020/06/25/%E5%A6%82%E4%BD%95%E5%AE%89%E8%A3%85%E7%89%B9%E5%AE%9A%E7%89%88%E6%9C%AC%E7%9A%84dotnet%20sdk/</id>
    <published>2020-06-25T13:47:41.999Z</published>
    <updated>2020-06-28T06:45:59.851Z</updated>
    
    <content type="html"><![CDATA[<p>在ubuntu上通过package mananger安装dotnet sdk默认情况下会自动安装最新版的,但有些时候我们并不希望安装最新版，而是安装一个特定的版本，这个时候可以通过一下三种方法：</p><ol><li>执行<a href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-install-script" target="_blank" rel="noopener">dotnet-install</a> 并指定特定版本号，如:</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;dotnet-install.sh --version 3.1.201</span><br></pre></td></tr></table></figure><ol start="2"><li>手动下载二进制tar包并解压（比较麻烦）</li><li>通过package mananger进行安装(官网目前没有介绍这种方法)</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#首先查看目前可安装的包版本</span><br><span class="line">apt policy dotnet-sdk-3.1</span><br><span class="line">#安装指定版本</span><br><span class="line">apt-get install  dotnet-sdk-3.1&#x3D;3.1.201-1</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在ubuntu上通过package mananger安装dotnet sdk默认情况下会自动安装最新版的,但有些时候我们并不希望安装最新版，而是安装一个特定的版本，这个时候可以通过一下三种方法：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;执行&lt;a href=&quot;https://docs.mi
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Spring Data MongoDb 通过Gradle集成QureyDSL的配置方法</title>
    <link href="https://loremipsumsharp.github.io/2020/05/17/Spring%20Data%20MongoDb%20%E9%80%9A%E8%BF%87Gradle%E9%9B%86%E6%88%90QureyDSL%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95/"/>
    <id>https://loremipsumsharp.github.io/2020/05/17/Spring%20Data%20MongoDb%20%E9%80%9A%E8%BF%87Gradle%E9%9B%86%E6%88%90QureyDSL%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95/</id>
    <published>2020-05-17T15:39:20.000Z</published>
    <updated>2020-05-17T15:39:06.656Z</updated>
    
    <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>QueryDSL是一个通用的查询框架，专注于通过Java API构建类型安全的SQL查询。目前在 Github 上的发布的 Release 版本已经多达 251 个版本，目前最新版是 4.3.1 ，并且由 Querydsl Google组 和 StackOverflow 两个团队提供支持。QueryDSL 是一个框架，可用于构造静态类型的类似SQL的查询。可以通过诸如 QueryDSL 之类的 API 构造查询，而不是将查询编写为内联字符串或将其外部化为XML文件。</p><p>例如，与简单字符串相比，使用 API 的好处是</p><ul><li><p>IDE中的代码完成</p></li><li><p>几乎没有语法无效的查询</p></li><li><p>可以安全地引用域类型和属性</p></li><li><p>更好地重构域类型的更改</p></li></ul><p>目前网上能够查阅到通过gradle集成QueryDSL的资料非常少，大部分是基于Maven，基于gradle的配置方法很多都是错的（这个是由于gradle的版本升级，新版本的gradle对QueryDSL没有做到向下兼容）</p><h2 id="gradle配置方法"><a href="#gradle配置方法" class="headerlink" title="gradle配置方法"></a>gradle配置方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id &#39;org.springframework.boot&#39; version &#39;2.2.5.RELEASE&#39;</span><br><span class="line">    id &#39;io.spring.dependency-management&#39; version &#39;1.0.9.RELEASE&#39;</span><br><span class="line">    id &#39;java&#39;</span><br><span class="line">    id &quot;com.ewerk.gradle.plugins.querydsl&quot; version &quot;1.0.10&quot;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">group &#x3D; &#39;io.loremipsum&#39;</span><br><span class="line">version &#x3D; &#39;0.0.1-SNAPSHOT&#39;</span><br><span class="line">sourceCompatibility &#x3D; &#39;11&#39;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">querydsl &#123;</span><br><span class="line">    library &#x3D; &#39;com.querydsl:querydsl-apt:4.1.4&#39;</span><br><span class="line">    querydslSourcesDir &#x3D; &#39;src&#x2F;main&#x2F;querydsl&#39;</span><br><span class="line">    springDataMongo &#x3D; true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sourceSets &#123;</span><br><span class="line">    main &#123;</span><br><span class="line">        java &#123;</span><br><span class="line">            srcDirs &#x3D; [&#39;src&#x2F;main&#x2F;java&#39;, &#39;src&#x2F;main&#x2F;querydsl&#39;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 当gradle版本&gt;5.0的时候需要加上这个配置</span><br><span class="line">compileQuerydsl &#123;</span><br><span class="line">    options.annotationProcessorPath &#x3D; configurations.querydsl</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile &#39;org.springframework.boot:spring-boot-starter-data-mongodb&#39;</span><br><span class="line">    compile &#39;org.springframework.boot:spring-boot-starter-web&#39;</span><br><span class="line"></span><br><span class="line">    compile(&quot;com.querydsl:querydsl-core:4.1.4&quot;)</span><br><span class="line">    compile(&quot;com.querydsl:querydsl-mongodb:4.1.4&quot;)</span><br><span class="line">    compile(&quot;com.querydsl:querydsl-apt:4.1.4&quot;)</span><br><span class="line"></span><br><span class="line">    compile &#39;org.projectlombok:lombok&#39;</span><br><span class="line">    annotationProcessor &#39;org.projectlombok:lombok&#39;</span><br><span class="line"></span><br><span class="line">    testCompile(&#39;org.springframework.boot:spring-boot-starter-test&#39;)</span><br><span class="line">    testCompile &#39;de.flapdoodle.embed:de.flapdoodle.embed.mongo&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意上述配置mongodb的依赖必须声明为compile（如果通过spring boot initializer创建项目,这里会被声明为implementation)，否则会提示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Annotation processor &#39;org.springframework.data.mongodb.repository.support.MongoAnnotationProcessor&#39; not found</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/babycomeon/p/11605809.html" target="_blank" rel="noopener">Spring Boot （六）： 为 JPA 插上翅膀的 QueryDSL</a></p><p><a href="https://stackoverflow.com/questions/53913274/querydsl-annotation-processor-issue-after-upgrade-to-gradle-5" target="_blank" rel="noopener">Querydsl Annotation Processor issue after upgrade to Gradle 5</a></p><p><a href="https://github.com/ewerk/gradle-plugins/issues/108" target="_blank" rel="noopener">querydsl-plugin don’t work in Gradle 5.0</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;引言&quot;&gt;&lt;a href=&quot;#引言&quot; class=&quot;headerlink&quot; title=&quot;引言&quot;&gt;&lt;/a&gt;引言&lt;/h2&gt;&lt;p&gt;QueryDSL是一个通用的查询框架，专注于通过Java API构建类型安全的SQL查询。目前在 Github 上的发布的 Release 
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>使用ValueTask减少假异步代码引起的GC</title>
    <link href="https://loremipsumsharp.github.io/2020/04/27/%E4%BD%BF%E7%94%A8ValueTask%E5%87%8F%E5%B0%91%E5%81%87%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81%E5%BC%95%E8%B5%B7%E7%9A%84GC/"/>
    <id>https://loremipsumsharp.github.io/2020/04/27/%E4%BD%BF%E7%94%A8ValueTask%E5%87%8F%E5%B0%91%E5%81%87%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81%E5%BC%95%E8%B5%B7%E7%9A%84GC/</id>
    <published>2020-04-27T14:43:07.391Z</published>
    <updated>2020-04-30T04:50:56.002Z</updated>
    
    <content type="html"><![CDATA[<h2 id="async-await代码存在的问题"><a href="#async-await代码存在的问题" class="headerlink" title="async/await代码存在的问题"></a>async/await代码存在的问题</h2><p>async/await是.NET4.5引入的一个语法糖，如下所示，下面的代码首先会以同步的方法判断一个文件是否存在，如果存在，那么就会已异步的方式去读取文件的内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public async Task&lt;string&gt; ReadFileAsync(string filename)</span><br><span class="line">&#123;</span><br><span class="line">    if (!File.Exists(filename))</span><br><span class="line">        return string.Empty;</span><br><span class="line">    return await File.ReadAllTextAsync(filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过async/await开发人员可以编写更加简洁的异步代码，通过IL SPY我们可以观察到，编译器实际上将async/await转为为了一个StateMachine,如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[AsyncStateMachine(typeof(Program.&lt;ReadFileAsync&gt;d__14))]</span><br><span class="line">public Task&lt;string&gt; ReadFileAsync(string filename)</span><br><span class="line">&#123;</span><br><span class="line">    Program.&lt;ReadFileAsync&gt;d__14 &lt;ReadFileAsync&gt;d__;</span><br><span class="line">    &lt;ReadFileAsync&gt;d__.filename &#x3D; filename;</span><br><span class="line">    &lt;ReadFileAsync&gt;d__.&lt;&gt;t__builder &#x3D; AsyncTaskMethodBuilder&lt;string&gt;.</span><br><span class="line">    Create();</span><br><span class="line">    &lt;ReadFileAsync&gt;d__.&lt;&gt;1__state &#x3D; -1;</span><br><span class="line">    AsyncTaskMethodBuilder&lt;string&gt; &lt;&gt;t__builder &#x3D; &lt;ReadFileAsync&gt;d__.&lt;&gt;t__</span><br><span class="line">    builder;</span><br><span class="line">    &lt;&gt;t__builder.Start&lt;Program.&lt;ReadFileAsync&gt;d__14&gt;(ref &lt;ReadFileAsync&gt;d__);</span><br><span class="line">    return &lt;ReadFileAsync&gt;d__.&lt;&gt;t__builder.Task;</span><br><span class="line">&#125;</span><br><span class="line">[CompilerGenerated]</span><br><span class="line">[StructLayout(LayoutKind.Auto)]</span><br><span class="line">private struct &lt;ReadFileAsync&gt;d__14 : IAsyncStateMachine</span><br><span class="line">&#123;</span><br><span class="line">    void IAsyncStateMachine.MoveNext()</span><br><span class="line">    &#123;</span><br><span class="line">        int num &#x3D; this.&lt;&gt;1__state;</span><br><span class="line">        string result;</span><br><span class="line">        try</span><br><span class="line">        &#123;</span><br><span class="line">            TaskAwaiter&lt;string&gt; awaiter;</span><br><span class="line">            if (num !&#x3D; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                if (!File.Exists(this.filename))</span><br><span class="line">                &#123;</span><br><span class="line">                    result &#x3D; string.Empty;</span><br><span class="line">                    goto IL_A4;</span><br><span class="line">                &#125;</span><br><span class="line">                awaiter &#x3D; File.ReadAllTextAsync(this.filename,</span><br><span class="line">                default(CancellationToken)).GetAwaiter();</span><br><span class="line">                if (!awaiter.get_IsCompleted())</span><br><span class="line">                &#123;</span><br><span class="line">                    this.&lt;&gt;1__state &#x3D; 0;</span><br><span class="line">                    this.&lt;&gt;u__1 &#x3D; awaiter;</span><br><span class="line">                    this.&lt;&gt;t__builder.AwaitUnsafeOnCompleted&lt;TaskAwaiter</span><br><span class="line">                    &lt;string&gt;, Program.&lt;ReadFileAsync&gt;d__14&gt;(ref awaiter, ref</span><br><span class="line">                    this);</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            awaiter &#x3D; this.&lt;&gt;u__1;</span><br><span class="line">            this.&lt;&gt;u__1 &#x3D; default(TaskAwaiter&lt;string&gt;);</span><br><span class="line">            this.&lt;&gt;1__state &#x3D; -1;</span><br><span class="line">        &#125;   </span><br><span class="line">        result &#x3D; awaiter.GetResult();</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception exception)</span><br><span class="line">    &#123;</span><br><span class="line">        this.&lt;&gt;1__state &#x3D; -2;</span><br><span class="line">        this.&lt;&gt;t__builder.SetException(exception);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IL_A4:</span><br><span class="line">    this.&lt;&gt;1__state &#x3D; -2;</span><br><span class="line">    this.&lt;&gt;t__builder.SetResult(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意到上面的代码，当文件不存在的时候会执行goto语句，也就是this.&lt;&gt;t__builder.SetResult(result)，t_builder是AsyncTaskMethodBuilder<T>的一个实例，<br>我们可以看下SetResult的<a href="https://github.com/dotnet/runtime/blob/110282c71b3f7e1f91ea339953f4a0eba362a62c/src/libraries/System.Private.CoreLib/src/System/Runtime/CompilerServices/AsyncTaskMethodBuilderT.cs" target="_blank" rel="noopener">实现</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void SetResult(TResult result)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; Get the currently stored task, which will be non-null if get_Task has already been accessed.</span><br><span class="line">    &#x2F;&#x2F; If there isn&#39;t one, get a task and store it.</span><br><span class="line">    if (m_task is null)</span><br><span class="line">    &#123;</span><br><span class="line">        m_task &#x3D; GetTaskForResult(result);</span><br><span class="line">        Debug.Assert(m_task !&#x3D; null, $&quot;&#123;nameof(GetTaskForResult)&#125; should never return null&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; Slow path: complete the existing task.</span><br><span class="line">        SetExistingTaskResult(m_task, result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于此时这个时候并产生真正的异步操作，所以m_task is null 成立,查看GetTaskForResult(result)：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[MethodImpl(MethodImplOptions.AggressiveInlining)] </span><br><span class="line">&#x2F;&#x2F; method looks long, but for a given TResult it results in a relatively small amount of asm</span><br><span class="line">internal static Task&lt;TResult&gt; GetTaskForResult(TResult result)</span><br><span class="line">&#123;</span><br><span class="line">    if (null !&#x3D; (object?)default(TResult)) &#x2F;&#x2F; help the JIT avoid the value type branches for ref types</span><br><span class="line">    &#123;</span><br><span class="line">        .....</span><br><span class="line">    &#125;</span><br><span class="line">    else if (result &#x3D;&#x3D; null) &#x2F;&#x2F; optimized away for value types</span><br><span class="line">    &#123;</span><br><span class="line">        return s_defaultResultTask;</span><br><span class="line">    &#125;</span><br><span class="line">    return new Task&lt;TResult&gt;(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于string是引用类型且result不为null,所以必然会导致一个新的Task对象被创建，那么也就是说，即便不存在异步调用，也会创建一个新的Task对象，如果存在大量的假异步调用，势必会造成成大量的一代GC，从而影响程序的性能。</p><h2 id="问题的解决"><a href="#问题的解决" class="headerlink" title="问题的解决"></a>问题的解决</h2><p>为了解决上述问题，.NET CORE 2.1引入了一个新的概念，ValueTask：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public struct ValueTask&lt;TResult&gt;</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    IValueTaskSource&lt;TResult&gt;</span><br><span class="line">    internal readonly object _obj;</span><br><span class="line">    internal readonly TResult _result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用ValueTask改写ReadFile代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public async ValueTask&lt;string&gt; ReadFileAsync(string filename)</span><br><span class="line">&#123;</span><br><span class="line">    if (!File.Exists(filename))</span><br><span class="line">        return string.Empty;</span><br><span class="line">    return await File.ReadAllTextAsync(filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当调用ReadFileAsync时，可以使用ValueTask.IsCompleted来判断这个调用是不是假异步调用，如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var valueTask &#x3D; ReadFileAsync();</span><br><span class="line">if(valueTask.IsCompleted)</span><br><span class="line">&#123;</span><br><span class="line">    return valueTask.Result;</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">    return await valueTask.AsTask();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果假异步调用，IsCompleted为true，这个时候返回valueTask.Result,不会产生Task对象的分配而ValueTask本身也是一个值类型，也不会产生allocation。反之，如果是真异步调用则按照原来的逻辑去执行。</p><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>当应用程序对性能要求比较苛刻的时候并且存在大量假异步调用的情况下，可以考虑使用ValueTask来提高性能。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;async-await代码存在的问题&quot;&gt;&lt;a href=&quot;#async-await代码存在的问题&quot; class=&quot;headerlink&quot; title=&quot;async/await代码存在的问题&quot;&gt;&lt;/a&gt;async/await代码存在的问题&lt;/h2&gt;&lt;p&gt;async/
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>高并发场景下StackExchange.Redis驱动的超时问题</title>
    <link href="https://loremipsumsharp.github.io/2020/04/25/%E9%AB%98%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8BStackExchange.Redis%E9%A9%B1%E5%8A%A8%E7%9A%84%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98/"/>
    <id>https://loremipsumsharp.github.io/2020/04/25/%E9%AB%98%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8BStackExchange.Redis%E9%A9%B1%E5%8A%A8%E7%9A%84%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98/</id>
    <published>2020-04-25T05:40:09.000Z</published>
    <updated>2020-04-28T02:58:56.213Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h2><p>近期部门的大量微服务在做国际化改造。为了实现国际化需求，需要有一个支撑服务用于提供用户ip信息数据。由于是支撑服务，会产生大量调用，大概每分钟2000次的调用，为了进一步提供性能，该服务会把用户的ip信息缓存到redis以避免重复调用第三方接口获取ip数据。<br>上线前对该服务进行了压力测试，发现在高并发的场景下，会频繁发生<br><strong>StackExchange.Redis.RedisTimeoutException</strong>异常，这对于一个支撑服务来说是不可接受的。</p><h2 id="问题重现"><a href="#问题重现" class="headerlink" title="问题重现"></a>问题重现</h2><p>使用grpc压力测试工具<a href="https://github.com/bojand/ghz" target="_blank" rel="noopener">ghz</a>模拟高并发场景：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ghz 192.168.1.44:43667 --insecure \</span><br><span class="line">--proto ..&#x2F;..&#x2F;proto&#x2F;FM.Region.Client&#x2F;Region.proto \</span><br><span class="line">--call Region.RegionSrv&#x2F;GetRegionInfoDetailByIp \</span><br><span class="line"> --concurrency 400 \</span><br><span class="line">-n 1200 \</span><br><span class="line">-D  .&#x2F;ip.json</span><br></pre></td></tr></table></figure><p>1200请求，400个并发，共3轮测试</p><p>测试ip数据集如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;27.220.195.252&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;32.213.120.200&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;58.88.5.142&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;99.107.218.202&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;126.179.177.51&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;75.179.58.40&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;92.243.129.145&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;179.240.146.239&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;54.99.209.135&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;116.125.57.197&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;104.243.227.11&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;65.175.113.237&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;92.160.105.28&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;51.189.156.232&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;101.136.19.162&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;128.78.227.70&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;123.139.77.54&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;172.234.209.119&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;187.172.248.233&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;28.8.211.1&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;130.96.236.81&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;88.162.103.72&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;166.2.94.121&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;102.106.115.156&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;19.148.120.200&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;219.240.103.98&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;221.17.125.56&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;91.236.176.82&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;41.237.239.70&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;145.55.30.213&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;139.135.98.132&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;72.143.86.138&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;198.225.10.195&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;136.234.70.30&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;103.89.118.202&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;44.250.218.13&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;116.207.166.76&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;140.238.239.80&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;31.158.163.164&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;182.215.64.241&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;220.197.147.157&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;117.254.129.148&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;94.184.10.88&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;219.61.223.175&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;185.172.199.161&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;184.69.18.249&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;166.64.229.72&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;212.98.0.204&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;160.59.24.87&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;48.195.150.66&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;147.186.60.20&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;138.19.147.96&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;8.43.149.29&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;108.94.149.179&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;111.177.253.182&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;99.160.130.179&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;125.194.19.83&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;26.100.156.127&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;105.18.80.126&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;128.141.4.89&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;80.20.225.251&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;41.253.214.98&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;36.5.58.33&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;56.52.122.254&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;162.240.161.83&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;195.221.65.187&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;223.215.140.121&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;42.254.253.187&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;99.236.88.173&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;87.49.237.85&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;124.230.221.226&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;46.22.123.116&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;105.85.140.56&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;69.167.167.233&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;176.44.47.123&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;40.225.1.63&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;102.209.225.101&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;62.173.169.38&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;51.133.22.72&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;31.129.69.30&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;194.133.28.78&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;9.243.223.78&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;185.107.13.97&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;IP&quot;: &quot;155.131.137.219&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>测试输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Summary:</span><br><span class="line">  Count:        1200</span><br><span class="line">  Total:        36.67 s</span><br><span class="line">  Slowest:      19.65 s</span><br><span class="line">  Fastest:      1.01 s</span><br><span class="line">  Average:      11.12 s</span><br><span class="line">  Requests&#x2F;sec: 32.72</span><br><span class="line"></span><br><span class="line">Response time histogram:</span><br><span class="line">  1011.354 [1]  |</span><br><span class="line">  2875.261 [8]  |∎</span><br><span class="line">  4739.167 [13] |∎</span><br><span class="line">  6603.074 [17] |∎∎</span><br><span class="line">  8466.981 [230]        |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  10330.887 [117]       |∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  12194.794 [440]       |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  14058.701 [172]       |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  15922.608 [145]       |∎∎∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  17786.514 [44]        |∎∎∎∎</span><br><span class="line">  19650.421 [7] |∎</span><br><span class="line"></span><br><span class="line">Latency distribution:</span><br><span class="line">  10%% in 8.15 s</span><br><span class="line">  25%% in 9.21 s</span><br><span class="line">  50%% in 11.17 s</span><br><span class="line">  75%% in 12.50 s</span><br><span class="line">  90%% in 14.51 s</span><br><span class="line">  95%% in 15.28 s</span><br><span class="line">  99%% in 17.24 s</span><br><span class="line"></span><br><span class="line">Status code distribution:</span><br><span class="line">  [OK]                 1194 responses</span><br><span class="line">  [DeadlineExceeded]   6 responses</span><br><span class="line"></span><br><span class="line">Error distribution:</span><br><span class="line">  [5]   rpc error: code &#x3D; DeadlineExceeded desc &#x3D; context deadline exceeded</span><br><span class="line">  [1]   rpc error: code &#x3D; DeadlineExceeded desc &#x3D; Deadline Exceeded</span><br></pre></td></tr></table></figure><p>测试输出提示请求超时，而且大量请求响应时间很不理想，查看日志发现StackExchange.Redis.RedisTimeoutException异常：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StackExchange.Redis.RedisTimeoutException: Timeout performing EVAL, inst: 5, queue: 1032, qu: 0, qs: 1032, qc: 0, wr: 0, wq: 0, in: 97489, ar: 0, clientName: , serverEndpoint: 192.168.1.44:43667, keyHashSlot: 693 (Please take a look at this article for some common client-side issues that can cause timeouts: http:\&#x2F;\&#x2F;stackexchange.github.io\&#x2F;StackExchange.Redis\&#x2F;Timeouts)\n   at StackExchange.Redis.ConnectionMultiplexer.ExecuteSyncImpl[T](Message message, ResultProcessor&#96;1 processor, ServerEndPoint server ...</span><br></pre></td></tr></table></figure><h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><p>根据<a href="https://github.com/StackExchange/StackExchange.Redis/blob/master/docs/Timeouts.md" target="_blank" rel="noopener">StackExchange.Redis官方文档</a>描述,在高并发场景下，当StackExchange.Redis的内部线程池无法满足并发要求的时候会去请求CLR的全局线程池，全局线程池的初始线程数量是根据CPU的核心数来确定的，当全局线程池的线程不够用的时候，会以500ms/per thread的速度往线程池里面添加新的线程，但这个速度在高并发场景下还是远远不够的，为此需要配置CLR线程池的最小线程数来满足高并发的场景。<br>在程序入口添加如下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ThreadPool.SetMinThreads(512, 100) &#x2F;&#x2F;worker最小线程数512,IOCP最小线程数100</span><br></pre></td></tr></table></figure><h2 id="问题验证"><a href="#问题验证" class="headerlink" title="问题验证"></a>问题验证</h2><p>配置最小线程数后再进行压力测试，测试输出如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Summary:</span><br><span class="line">  Count:        1200</span><br><span class="line">  Total:        2.66 s</span><br><span class="line">  Slowest:      2.15 s</span><br><span class="line">  Fastest:      1.99 ms</span><br><span class="line">  Average:      827.12 ms</span><br><span class="line">  Requests&#x2F;sec: 451.92</span><br><span class="line"></span><br><span class="line">Response time histogram:</span><br><span class="line">  1.987 [1]     |</span><br><span class="line">  216.449 [66]  |∎∎∎∎∎∎∎</span><br><span class="line">  430.911 [174] |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  645.373 [403] |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  859.835 [136] |∎∎∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  1074.297 [75] |∎∎∎∎∎∎∎</span><br><span class="line">  1288.759 [48] |∎∎∎∎∎</span><br><span class="line">  1503.221 [69] |∎∎∎∎∎∎∎</span><br><span class="line">  1717.683 [156]        |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span><br><span class="line">  1932.145 [13] |∎</span><br><span class="line">  2146.607 [59] |∎∎∎∎∎∎</span><br><span class="line"></span><br><span class="line">Latency distribution:</span><br><span class="line">  10%% in 332.77 ms</span><br><span class="line">  25%% in 445.91 ms</span><br><span class="line">  50%% in 547.70 ms</span><br><span class="line">  75%% in 1.28 s</span><br><span class="line">  90%% in 1.68 s</span><br><span class="line">  95%% in 1.91 s</span><br><span class="line">  99%% in 2.11 s</span><br><span class="line"></span><br><span class="line">Status code distribution:</span><br><span class="line">  [OK]   1200 responses</span><br></pre></td></tr></table></figure><p>超时问题消失,并且响应时间大幅度减小</p><p>需要注意的是，如果机器配置不够（CPU跑满了)，再高并发场景下，仍然会出现超时问题。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;问题背景&quot;&gt;&lt;a href=&quot;#问题背景&quot; class=&quot;headerlink&quot; title=&quot;问题背景&quot;&gt;&lt;/a&gt;问题背景&lt;/h2&gt;&lt;p&gt;近期部门的大量微服务在做国际化改造。为了实现国际化需求，需要有一个支撑服务用于提供用户ip信息数据。由于是支撑服务，会产生大
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>记线上的一次Mysql死锁问题分析</title>
    <link href="https://loremipsumsharp.github.io/2020/03/14/%E8%AE%B0%E7%BA%BF%E4%B8%8A%E7%9A%84%E4%B8%80%E6%AC%A1Mysql%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/"/>
    <id>https://loremipsumsharp.github.io/2020/03/14/%E8%AE%B0%E7%BA%BF%E4%B8%8A%E7%9A%84%E4%B8%80%E6%AC%A1Mysql%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/</id>
    <published>2020-03-14T02:10:39.000Z</published>
    <updated>2020-04-28T02:58:16.285Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>最近上线了叫做“F币”的功能，简单说下就是系统会根据用户每天在社区的活跃行为，计算每一个用户的活跃度，最后根据用户每天的总活跃度返还相应的“F币”给用户，用户得到F币之后可以在社区兑换不同的礼品,如下图所示：<br><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/BF0B1ABB-F459-4343-BE90-5177FB6583D5.png" alt=""></p><p>在测试环境和仿真环境运行的好好的，但是上线之后经常接到用户反馈，需要多次点击才能完成领取。查看阿里云日志，提示数据库产生死锁，如下图所示：<br><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/9DF85AF7-0840-4323-9B0C-613480533A45.png" alt=""></p><h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>注意到这里有一排按钮，用户的每次点击，后台都会进行以下两个操作：</p><ol><li>更新用户余额（用户表）</li><li>生成流水记录 （用户流水记录）</li></ol><p>注：用户表和流水表存在主外键关系</p><p>以上的两个操作会放在同一个事务完成，并且由于Ef的SaveChanges并不会根据你代码执行的先后次序去更新数据库，当用户以很快的速度从左到右依次点击，存在以下可能：</p><p>T1:事务A插入流水，由于存在外键，会对user对应的行上S锁。</p><p>T2:事务B插入流水，由于存在外键，会对user对应的行上S锁。</p><p>T3:事务A更新User的余额，请求行记录的X锁，被B事务在T2的S锁阻塞</p><p>T4:事务B更新User的余额，请求行记录的X锁，被A事务在T1的S锁阻塞</p><p>至此死锁产生。</p><h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><p>用了一个比较简单+暴力的方法：领取接口直接上redis分布式锁。</p><h2 id="总结与反思"><a href="#总结与反思" class="headerlink" title="总结与反思"></a>总结与反思</h2><p>这个项目是使用DDD的思想进行开发的，自然而然地在ORM上面的选型使用了EntityFramework Code First,但是Code Firit在建表的时候会自做主张的在“多”端生成外键。对外键的使用，除开了一部分性能开销，就是上述的死锁问题，后续考虑把这部分重构为DbFirst。</p><p>另外值得一提的是，后来对这部逻辑做了压测，发现这部分代码在Sql Server跑是没问题的，因为Sql Server在插入子表的时候不会对父表记录上锁，而Mysql会对父表上锁,所以产生了死锁，天下果然没有免费午餐！</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://stackoverflow.com/questions/7335582/dbcontext-savechanges-order-of-statement-execution" target="_blank" rel="noopener">DbContext SaveChanges Order of Statement Execution</a></p><p><a href="https://bugs.mysql.com/bug.php?id=48652" target="_blank" rel="noopener">Deadlock due to Foreign Key constraint</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h2&gt;&lt;p&gt;最近上线了叫做“F币”的功能，简单说下就是系统会根据用户每天在社区的活跃行为，计算每一个用户的活跃度，最后根据用户每天的总活
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>AspNetCore2.1升级到3.1时CORS相关配置的变更</title>
    <link href="https://loremipsumsharp.github.io/2020/02/27/AspNetCore2.1%E5%8D%87%E7%BA%A7%E5%88%B03.1%E6%97%B6CORS%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%E7%9A%84%E5%8F%98%E6%9B%B4/"/>
    <id>https://loremipsumsharp.github.io/2020/02/27/AspNetCore2.1%E5%8D%87%E7%BA%A7%E5%88%B03.1%E6%97%B6CORS%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%E7%9A%84%E5%8F%98%E6%9B%B4/</id>
    <published>2020-02-27T12:05:33.000Z</published>
    <updated>2020-04-28T02:57:21.278Z</updated>
    
    <content type="html"><![CDATA[<p>本周将公司的运营系统从AspNetCore2.1升级到了AspNetCore3.1,遇到了一些坑，这里记录以下</p><h2 id="2-1的相关CORS代码"><a href="#2-1的相关CORS代码" class="headerlink" title="2.1的相关CORS代码"></a>2.1的相关CORS代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public IServiceProvider ConfigureServices(IServiceCollection services)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">        ... &#x2F;&#x2F; 省略</span><br><span class="line">        services.AddCors(option &#x3D;&gt; option.AddPolicy(&quot;corsPolicy&quot;, builders &#x3D;&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            builders.AllowCredentials().AllowAnyOrigin().AllowAnyHeader().AllowAnyMethod();</span><br><span class="line">        &#125;));</span><br><span class="line">        ... &#x2F;&#x2F; 省略</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void Configure(IApplicationBuilder app, ILoggerFactory loggerFactory, IHostingEnvironment env)</span><br><span class="line">&#123;</span><br><span class="line">    ... &#x2F;&#x2F; 省略</span><br><span class="line">    app.UseCors(&quot;corsPolicy&quot;);</span><br><span class="line">     ... &#x2F;&#x2F; 省略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果这部分代码这3.1的服务中不加任何修改，启动时提示错误：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The CORS protocol does not allow specifying a wildcard (any) origin and credentials at the same time. Configure the CORS policy by listing individual origins if credentials needs to be supported.</span><br></pre></td></tr></table></figure><p>这是由于在2.1之后,AspNetCore出于安全考虑，做了更加严格的限制，在不AllowCredentials()与AllowAnyOrigin()。</p><p>假设现在站点A存在一个恶意脚本，而站点B存在一个比较的敏感的接口（如转账）。如果站点B作为服务端使用AllowCredentials()与AllowAnyOrigin()的同源配置，此时站点A可以直接调用站点B的敏感接口并发送凭证信息（如Cookie），那么将导致用户信息被窃取。</p><h2 id="3-1的相关CORS代码"><a href="#3-1的相关CORS代码" class="headerlink" title="3.1的相关CORS代码"></a>3.1的相关CORS代码</h2><h3 id="options1-显示声明允许跨域的origin"><a href="#options1-显示声明允许跨域的origin" class="headerlink" title="options1 显示声明允许跨域的origin"></a>options1 显示声明允许跨域的origin</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">services.AddCors(option &#x3D;&gt; option.AddPolicy(&quot;corsPolicy&quot;, builders &#x3D;&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                builders.WithOrigins(&quot;http:&#x2F;&#x2F;site.com&quot;).AllowAnyHeader().AllowAnyMethod().AllowCredentials();</span><br><span class="line">            &#125;));</span><br></pre></td></tr></table></figure><h3 id="options2-使用-SetIsOriginAllowed（可以起到与AllowAnyOriginu一样的效果）"><a href="#options2-使用-SetIsOriginAllowed（可以起到与AllowAnyOriginu一样的效果）" class="headerlink" title="options2 使用 SetIsOriginAllowed（可以起到与AllowAnyOriginu一样的效果）"></a>options2 使用 SetIsOriginAllowed（可以起到与AllowAnyOriginu一样的效果）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">services.AddCors(option &#x3D;&gt; option.AddPolicy(&quot;corsPolicy&quot;, builders &#x3D;&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                builders.SetIsOriginAllowed(origin&#x3D;&gt;true).AllowAnyHeader().AllowAnyMethod().AllowCredentials(); &#x2F;&#x2F;SetIsOriginAllowed(origin&#x3D;&gt;true)允许所有origin</span><br><span class="line">            &#125;));</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;本周将公司的运营系统从AspNetCore2.1升级到了AspNetCore3.1,遇到了一些坑，这里记录以下&lt;/p&gt;
&lt;h2 id=&quot;2-1的相关CORS代码&quot;&gt;&lt;a href=&quot;#2-1的相关CORS代码&quot; class=&quot;headerlink&quot; title=&quot;2.1的相
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>InnodDB中的Gap Locks与Next-key Locks</title>
    <link href="https://loremipsumsharp.github.io/2020/02/11/InnodDB%E4%B8%AD%E7%9A%84Gap%20Locks%E4%B8%8ENext-key%20Locks/"/>
    <id>https://loremipsumsharp.github.io/2020/02/11/InnodDB%E4%B8%AD%E7%9A%84Gap%20Locks%E4%B8%8ENext-key%20Locks/</id>
    <published>2020-02-11T13:12:33.000Z</published>
    <updated>2020-04-28T02:56:56.340Z</updated>
    
    <content type="html"><![CDATA[<p>为了理解Gap Locks与Next-key Locks首先必须了解InnodDB定义的四种隔离级别</p><h2 id="InnodDB的四种隔离级别"><a href="#InnodDB的四种隔离级别" class="headerlink" title="InnodDB的四种隔离级别"></a>InnodDB的四种隔离级别</h2><ol><li>Read uncommitted(未授权读取、读未提交)：如果一个事务已经开始写数据，则另外一个事务则不允许同时进行写操作，但允许其他事务读此行数据。该隔离级别可以通过“排他写锁”实现。这样就避免了更新丢失，却可能出现脏读。也就是说事务B读取到了事务A未提交的数据。</li><li>Read committed（授权读取、读提交）： 读取数据的事务允许其他事务继续访问该行数据，但是未提交的写事务将会禁止其他事务访问该行。该隔离级别避免了脏读，但是却可能出现不可重复读。事务A事先读取了数据，事务B紧接了更新了数据，并提交了事务，而事务A再次读取该数据时，数据已经发生了改变。</li><li>Repeatable read（可重复读取,MySQL默认隔离级别）： 可重复读是指在一个事务内，多次读同一数据。在这个事务还没有结束时，另外一个事务也访问该同一数据。那么，在第一个事务中的两次读数据之间，即使第二个事务对数据进行修改，第一个事务两次读到的的数据是一样的。这样就发生了在一个事务内两次读到的数据是一样的，因此称为是可重复读。读取数据的事务将会禁止写事务（但允许读事务），写事务则禁止任何其他事务。这样避免了不可重复读取和脏读，但是有时可能出现幻象读。（读取数据的事务）这可以通过“共享读锁”和“排他写锁”实现。</li><li>Serializable（序列化）： 提供严格的事务隔离。它要求事务序列化执行，事务只能一个接着一个地执行，但不能并发执行。如果仅仅通过“行级锁”是无法实现事务序列化的，必须通过其他机制保证新插入的数据不会被刚执行查询操作的事务访问到。序列化是最高的事务隔离级别，同时代价也花费最高，性能很低，一般很少使用，在该级别下，事务顺序执行，不仅可以避免脏读、不可重复读，还避免了幻像读。 </li></ol><h2 id="Gap-Locks"><a href="#Gap-Locks" class="headerlink" title="Gap Locks"></a>Gap Locks</h2><p>如下图所示：假设存在一个索引(Key,pk),那么当innodb在一事务中中对(-∞,(9,5)]追加Gap Locks后,如果其他事务尝试在索引记录中的任意一个Gap添加记录,该事务将会被阻塞<br><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/WeChat%20Screenshot_20200217021548.png" alt=""></p><h2 id="Next-key-Locks"><a href="#Next-key-Locks" class="headerlink" title="Next-key Locks"></a>Next-key Locks</h2><p>Next-key Locks = Gap Locks + index-record lock。<br>当在某一个事务中执行一个SELECT语句，Innodb会通过扫描相应的索引记录来找到生成一个ResultSet，这个时候被扫描到的索引记录都被被添加Next-key locks。<br>举个例子，假设现在存在一张表T，T的主键为ID，ID的可能值是10，11，13，20。<br>现在在一个事务中执行如下语句：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT ID FROM T WHERE ID &gt;&#x3D;10 AND ID &lt;&#x3D; 20 FOR UPDATE;</span><br></pre></td></tr></table></figure><p>这个时候会产生的Next-key Locks如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(-∞, 10]</span><br><span class="line">(10, 11]</span><br><span class="line">(11, 13]</span><br><span class="line">(13, 20]</span><br><span class="line">(20, +∞)</span><br></pre></td></tr></table></figure><p>其他事务不能这个范围内将不能插入新的纪录（避免了幻读），也不能修改相应的记录（避免了不可重复读）</p><p>可见Next-key Locks与Gap Locks主要是为了满足Repeatable read的一致性要求。</p><p>另外值得注意的一点是，如果被扫描到的索引是一个唯一索引，且只有并且只有一笔记录，那么这个时候只会上index-record lock，因为这个时候其他事务产生了新的记录，也不会产生幻读。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;为了理解Gap Locks与Next-key Locks首先必须了解InnodDB定义的四种隔离级别&lt;/p&gt;
&lt;h2 id=&quot;InnodDB的四种隔离级别&quot;&gt;&lt;a href=&quot;#InnodDB的四种隔离级别&quot; class=&quot;headerlink&quot; title=&quot;InnodD
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Maven库配置阿里云加速</title>
    <link href="https://loremipsumsharp.github.io/2020/01/19/Maven%E5%BA%93%E9%85%8D%E7%BD%AE%E9%98%BF%E9%87%8C%E4%BA%91%E5%8A%A0%E9%80%9F/"/>
    <id>https://loremipsumsharp.github.io/2020/01/19/Maven%E5%BA%93%E9%85%8D%E7%BD%AE%E9%98%BF%E9%87%8C%E4%BA%91%E5%8A%A0%E9%80%9F/</id>
    <published>2020-01-19T08:30:20.000Z</published>
    <updated>2020-04-28T02:57:23.435Z</updated>
    
    <content type="html"><![CDATA[<p>由于国内的网络原因,通过maven拉取相关package的时候总是特别慢，极大的影响到工作效率。所幸的是阿里云提供了maven库的镜像服务，体验了一下，速度飞快。配置方法如下：</p><h2 id="Maven仓库配置阿里云加速"><a href="#Maven仓库配置阿里云加速" class="headerlink" title="Maven仓库配置阿里云加速"></a>Maven仓库配置阿里云加速</h2><ul><li>确定settings.xml配置文件位置<br>执行如下命令：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn -X</span><br></pre></td></tr></table></figure><p>输入如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.....省略</span><br><span class="line">[DEBUG] Reading global settings from &#x2F;usr&#x2F;share&#x2F;maven&#x2F;conf&#x2F;settings.xml</span><br><span class="line">[DEBUG] Reading user settings from &#x2F;home&#x2F;abc&#x2F;.m2&#x2F;settings.xml</span><br><span class="line">[DEBUG] Reading global toolchains from &#x2F;usr&#x2F;share&#x2F;maven&#x2F;conf&#x2F;toolchains.xml</span><br><span class="line">[DEBUG] Reading user toolchains from &#x2F;home&#x2F;loremipsum&#x2F;.m2&#x2F;toolchains.xml</span><br><span class="line">[DEBUG] Using local repository at &#x2F;home&#x2F;abc&#x2F;.m2&#x2F;repository</span><br><span class="line"></span><br><span class="line">.....省略</span><br></pre></td></tr></table></figure><ul><li>修改settings.xml,修改mirrors xml结点下的相关配置</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">  &lt;mirrors&gt;</span><br><span class="line">    &lt;!-- mirror</span><br><span class="line">     | Specifies a repository mirror site to use instead of a given repository. The repository that</span><br><span class="line">     | this mirror serves has an ID that matches the mirrorOf element of this mirror. IDs are used</span><br><span class="line">     | for inheritance and direct lookup purposes, and must be unique across the set of mirrors.</span><br><span class="line">     |</span><br><span class="line">    &lt;mirror&gt;</span><br><span class="line">      &lt;id&gt;mirrorId&lt;&#x2F;id&gt;</span><br><span class="line">      &lt;mirrorOf&gt;repositoryId&lt;&#x2F;mirrorOf&gt;</span><br><span class="line">      &lt;name&gt;Human Readable Name for this Mirror.&lt;&#x2F;name&gt;</span><br><span class="line">      &lt;url&gt;http:&#x2F;&#x2F;my.repository.com&#x2F;repo&#x2F;path&lt;&#x2F;url&gt;</span><br><span class="line">    &lt;&#x2F;mirror&gt;</span><br><span class="line">     --&gt;</span><br><span class="line">    &lt;mirror&gt;</span><br><span class="line">      &lt;id&gt;aliyun-public&lt;&#x2F;id&gt;</span><br><span class="line">      &lt;name&gt;aliyun public&lt;&#x2F;name&gt;</span><br><span class="line">      &lt;mirrorOf&gt;public&lt;&#x2F;mirrorOf&gt;</span><br><span class="line">      &lt;url&gt;https:&#x2F;&#x2F;maven.aliyun.com&#x2F;repository&#x2F;public&lt;&#x2F;url&gt;</span><br><span class="line">    &lt;&#x2F;mirror&gt;</span><br><span class="line"></span><br><span class="line">    &lt;mirror&gt;</span><br><span class="line">      &lt;id&gt;aliyun-central&lt;&#x2F;id&gt;</span><br><span class="line">      &lt;name&gt;aliyun central&lt;&#x2F;name&gt;</span><br><span class="line">      &lt;mirrorOf&gt;central&lt;&#x2F;mirrorOf&gt;</span><br><span class="line">      &lt;url&gt;https:&#x2F;&#x2F;maven.aliyun.com&#x2F;repository&#x2F;central&lt;&#x2F;url&gt;</span><br><span class="line">    &lt;&#x2F;mirror&gt;</span><br><span class="line"></span><br><span class="line">    &lt;mirror&gt;</span><br><span class="line">      &lt;id&gt;aliyun-jcenter&lt;&#x2F;id&gt;</span><br><span class="line">      &lt;name&gt;aliyun jcenter&lt;&#x2F;name&gt;</span><br><span class="line">      &lt;mirrorOf&gt;jcenter&lt;&#x2F;mirrorOf&gt;</span><br><span class="line">      &lt;url&gt;https:&#x2F;&#x2F;maven.aliyun.com&#x2F;repository&#x2F;jcenter&lt;&#x2F;url&gt;</span><br><span class="line">    &lt;&#x2F;mirror&gt;</span><br><span class="line"></span><br><span class="line">    &lt;mirror&gt;</span><br><span class="line">      &lt;id&gt;aliyun-spring&lt;&#x2F;id&gt;</span><br><span class="line">      &lt;name&gt;aliyun spring&lt;&#x2F;name&gt;</span><br><span class="line">      &lt;mirrorOf&gt;spring&lt;&#x2F;mirrorOf&gt;</span><br><span class="line">      &lt;url&gt;https:&#x2F;&#x2F;maven.aliyun.com&#x2F;repository&#x2F;spring&lt;&#x2F;url&gt;</span><br><span class="line">    &lt;&#x2F;mirror&gt;</span><br><span class="line"></span><br><span class="line">    &lt;mirror&gt;</span><br><span class="line">      &lt;id&gt;aliyun-spring-milestones&lt;&#x2F;id&gt;</span><br><span class="line">      &lt;name&gt;aliyun spring milestones&lt;&#x2F;name&gt;</span><br><span class="line">      &lt;mirrorOf&gt;spring-milestones&lt;&#x2F;mirrorOf&gt;</span><br><span class="line">      &lt;url&gt;https:&#x2F;&#x2F;maven.aliyun.com&#x2F;repository&#x2F;spring&lt;&#x2F;url&gt;</span><br><span class="line">    &lt;&#x2F;mirror&gt;</span><br><span class="line"></span><br><span class="line">    &lt;mirror&gt;</span><br><span class="line">      &lt;id&gt;aliyun-spring-plugin&lt;&#x2F;id&gt;</span><br><span class="line">      &lt;name&gt;aliyun spring plugin&lt;&#x2F;name&gt;</span><br><span class="line">      &lt;mirrorOf&gt;spring-plugin&lt;&#x2F;mirrorOf&gt;</span><br><span class="line">      &lt;url&gt;https:&#x2F;&#x2F;maven.aliyun.com&#x2F;repository&#x2F;spring-plugin&lt;&#x2F;url&gt;</span><br><span class="line">    &lt;&#x2F;mirror&gt;</span><br><span class="line"></span><br><span class="line">    &lt;mirror&gt;</span><br><span class="line">      &lt;id&gt;aliyun-gradle-plugin&lt;&#x2F;id&gt;</span><br><span class="line">      &lt;name&gt;aliyun gradle plugin&lt;&#x2F;name&gt;</span><br><span class="line">      &lt;mirrorOf&gt;gradle-plugin&lt;&#x2F;mirrorOf&gt;</span><br><span class="line">      &lt;url&gt;https:&#x2F;&#x2F;maven.aliyun.com&#x2F;repository&#x2F;gradle-plugin&lt;&#x2F;url&gt;</span><br><span class="line">    &lt;&#x2F;mirror&gt;</span><br><span class="line"></span><br><span class="line">    &lt;mirror&gt;</span><br><span class="line">      &lt;id&gt;aliyun-google&lt;&#x2F;id&gt;</span><br><span class="line">      &lt;name&gt;aliyun google&lt;&#x2F;name&gt;</span><br><span class="line">      &lt;mirrorOf&gt;google&lt;&#x2F;mirrorOf&gt;</span><br><span class="line">      &lt;url&gt;https:&#x2F;&#x2F;maven.aliyun.com&#x2F;repository&#x2F;google&lt;&#x2F;url&gt;</span><br><span class="line">    &lt;&#x2F;mirror&gt;</span><br><span class="line"></span><br><span class="line">    &lt;mirror&gt;</span><br><span class="line">      &lt;id&gt;aliyun-grails-core&lt;&#x2F;id&gt;</span><br><span class="line">      &lt;name&gt;aliyun grails core&lt;&#x2F;name&gt;</span><br><span class="line">      &lt;mirrorOf&gt;grails-core&lt;&#x2F;mirrorOf&gt;</span><br><span class="line">      &lt;url&gt;https:&#x2F;&#x2F;maven.aliyun.com&#x2F;repository&#x2F;grails-core&lt;&#x2F;url&gt;</span><br><span class="line">    &lt;&#x2F;mirror&gt;</span><br><span class="line">&lt;&#x2F;mirrors&gt;</span><br></pre></td></tr></table></figure><h2 id="防坑："><a href="#防坑：" class="headerlink" title="防坑："></a>防坑：</h2><p>大部分的包阿里云的maven镜像库都有，一部分比较新的库上面是没有的，如springboot，阿里云上面的版本只是到了2.2.0，实际2.2.4都已经出来了，同步不是很及时。目前我都一些没有的库做了降级处理，后续再看看怎么处理这个问题</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;由于国内的网络原因,通过maven拉取相关package的时候总是特别慢，极大的影响到工作效率。所幸的是阿里云提供了maven库的镜像服务，体验了一下，速度飞快。配置方法如下：&lt;/p&gt;
&lt;h2 id=&quot;Maven仓库配置阿里云加速&quot;&gt;&lt;a href=&quot;#Maven仓库配置阿
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Kafka连接超时问题的本质</title>
    <link href="https://loremipsumsharp.github.io/2020/01/15/Kafka%E8%BF%9E%E6%8E%A5%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98%E7%9A%84%E6%9C%AC%E8%B4%A8/"/>
    <id>https://loremipsumsharp.github.io/2020/01/15/Kafka%E8%BF%9E%E6%8E%A5%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98%E7%9A%84%E6%9C%AC%E8%B4%A8/</id>
    <published>2020-01-15T08:30:20.000Z</published>
    <updated>2020-04-30T04:44:13.707Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题的背景"><a href="#问题的背景" class="headerlink" title="问题的背景"></a>问题的背景</h2><p>前段时间开发环境搭建了一套kafka环境，搭建完成后通过客户端去连接kafka时，当produer调用send的时候程序都会直接hang住，提示连接超时：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.apache.kafka.common.errors.TimeoutException: </span><br><span class="line">Expiring 1 record(s) for demo-topic-0:120000 ms has passed since batch creation</span><br></pre></td></tr></table></figure><p>接着我试了一下调用producer的partitionsFor方法，可以正常执行。同样的，当consumer执行poll方法时，程序也会直接卡死。</p><h2 id="问题的本质"><a href="#问题的本质" class="headerlink" title="问题的本质"></a>问题的本质</h2><p>producer是通过leader broker往partition写入数据,当producer希望写入数据的时候会向kafka请求当前的leader broker信息，这个时候如果kafka的leader broker的host信息如果和客户端不在同一个网段就会出现上述的超时现象，这也就可以解释为什么partitionsFor方法可以正常执行(不涉及到leader broker的通信)，但是send方法(涉及到leader broker的通信)执行失败。</p><h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><p>配置ADVERTISED_HOST</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash-4.4# vi $KAFKA_HOME&#x2F;config&#x2F;server.properties</span><br></pre></td></tr></table></figure><p>这里我的配置是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">advertised.listeners&#x3D;PLAINTEXT:&#x2F;&#x2F;127.0.0.1:9092</span><br></pre></td></tr></table></figure><p>由于是使用docker部署，客户端和服务端不在同一台机器上，所以我需要把这个配置改为与客户端同一个网段的</p><h2 id="问题验证"><a href="#问题验证" class="headerlink" title="问题验证"></a>问题验证</h2><p>当ADVERTISED_HOST为PLAINTEXT://127.0.0.1:9092可以看到partitionsFor返回的leader broker信息为下图所示：<br><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/CD584EBE-9DDF-4bbb-AF15-7970A064979A.png" alt=""></p><p>修改ADVERTISED_HOST后，返回信息如下：<br><img src="https://raw.githubusercontent.com/LoremipsumSharp/Images/master/img/53CA72B0-F276-4ef7-B524-18C970ED3443.png" alt=""></p><p>没有再次出现连接超时的问题</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://rmoff.net/2018/08/02/kafka-listeners-explained/" target="_blank" rel="noopener">kafka-listeners-explained</a></p><p><a href="https://docs.cloudera.com/runtime/7.1.0/kafka-managing/topics/kafka-manage-client-broker-comp.html" target="_blank" rel="noopener">Client and broker compatibility across Kafka versions</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;问题的背景&quot;&gt;&lt;a href=&quot;#问题的背景&quot; class=&quot;headerlink&quot; title=&quot;问题的背景&quot;&gt;&lt;/a&gt;问题的背景&lt;/h2&gt;&lt;p&gt;前段时间开发环境搭建了一套kafka环境，搭建完成后通过客户端去连接kafka时，当produer调用send的时候
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>NetCore应用配置Auto Core Dump</title>
    <link href="https://loremipsumsharp.github.io/2020/01/09/NetCore%E5%BA%94%E7%94%A8%E9%85%8D%E7%BD%AEAuto%20Core%20Dump/"/>
    <id>https://loremipsumsharp.github.io/2020/01/09/NetCore%E5%BA%94%E7%94%A8%E9%85%8D%E7%BD%AEAuto%20Core%20Dump/</id>
    <published>2020-01-09T12:40:12.000Z</published>
    <updated>2020-04-28T02:55:59.580Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h2><p>前阵子线上用户标签服务频繁出现内存泄漏问题，早上服务运行的好好的，经常一到半夜服务就挂掉。由于事发半夜，很难加以人工干预，而早上dump出来的文件参考价值很低，迫切需要一种自动化的手段让服务在宕掉的时候能够保存完整的案发现场。事实上，.NET CORE可以支持这一需求，不过默认是不开启的，需要加以配置。</p><h2 id="Auto-Core-Dump配置方法"><a href="#Auto-Core-Dump配置方法" class="headerlink" title="Auto Core Dump配置方法"></a>Auto Core Dump配置方法</h2><p>以下内容是我原封不动从dotnet/rumtime这个仓库拷贝过来的：</p><p>Environment variables supported:</p><ul><li><code>COMPlus_DbgEnableMiniDump</code>: if set to “1”, enables this core dump generation. The default is NOT to generate a dump.</li><li><code>COMPlus_DbgMiniDumpType</code>: See below. Default is “2” MiniDumpWithPrivateReadWriteMemory.</li><li><code>COMPlus_DbgMiniDumpName</code>: if set, use as the template to create the dump path and file name. The pid can be placed in the name with %d. The default is <em>/tmp/coredump.%d</em>.</li><li><code>COMPlus_CreateDumpDiagnostics</code>: if set to “1”, enables the <em>createdump</em> utilities diagnostic messages (TRACE macro).</li></ul><p>COMPlus_DbgMiniDumpType values:</p><table><thead><tr><th>Value</th><th align="center">Minidump Enum</th><th>Description</th></tr></thead><tbody><tr><td>1</td><td align="center">MiniDumpNormal</td><td>Include just the information necessary to capture stack traces for all existing threads in a process. Limited GC heap memory and information.</td></tr><tr><td>2</td><td align="center">MiniDumpWithPrivateReadWriteMemory (default)</td><td>Includes the GC heaps and information necessary to capture stack traces for all existing threads in a process.</td></tr><tr><td>3</td><td align="center">MiniDumpFilterTriage</td><td>Include just the information necessary to capture stack traces for all existing threads in a process. Limited GC heap memory and information.</td></tr><tr><td>4</td><td align="center">MiniDumpWithFullMemory</td><td>Include all accessible memory in the process. The raw memory data is included at the end, so that the initial structures can be mapped directly without the raw memory information. This option can result in a very large file.</td></tr></tbody></table><p>根据以上内容，可以在Dockerfile或者docker-compose文件加入以下环境变量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ENV COMPlus_DbgEnableMiniDump&#x3D;&quot;1&quot;  # enables core dump generation</span><br><span class="line">ENV COMPlus_DbgMiniDumpName&#x3D;&quot;&#x2F;diagnostics&#x2F;dumps&#x2F;coredump_%d&quot; # core dump文件位置，一般是一个挂在在宿主机的目录</span><br><span class="line">ENV COMPlus_DbgMiniDumpType&#x3D;&quot;4&quot; # 建议选择4，也就是full dump，保存的“现场”更加完整，但文件也会非常大</span><br></pre></td></tr></table></figure><h2 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h2><p>在一个可以被调用的接口加入以下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Environment.FailFast()</span><br></pre></td></tr></table></figure><p>这个方法可以让应用直接挂掉,挂掉后观察相应的挂载目录有无生成dump文件</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://github.com/dotnet/runtime/blob/8497763bbfa70455e6f08ed7aa345d43db1d22d7/docs/design/coreclr/botr/xplat-minidump-generation.md" target="_blank" rel="noopener">xplat-minidump-generation</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;问题背景&quot;&gt;&lt;a href=&quot;#问题背景&quot; class=&quot;headerlink&quot; title=&quot;问题背景&quot;&gt;&lt;/a&gt;问题背景&lt;/h2&gt;&lt;p&gt;前阵子线上用户标签服务频繁出现内存泄漏问题，早上服务运行的好好的，经常一到半夜服务就挂掉。由于事发半夜，很难加以人工干预，而
      
    
    </summary>
    
    
    
  </entry>
  
</feed>
